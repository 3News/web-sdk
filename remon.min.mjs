import"webrtc-adapter";var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var platform=createCommonjsModule(function(e,t){(function(){var n={function:!0,object:!0},o=n[typeof window]&&window||this,i=n.object&&t,a=n.object&&e&&!e.nodeType&&e,r=i&&a&&"object"==typeof commonjsGlobal&&commonjsGlobal;!r||r.global!==r&&r.window!==r&&r.self!==r||(o=r);var c=Math.pow(2,53)-1,s=/\bOpera/,l=Object.prototype,d=l.hasOwnProperty,g=l.toString;function h(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function p(e){return e=b(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:h(e)}function v(e,t){for(var n in e)d.call(e,n)&&t(e[n],n,e)}function u(e){return null==e?h(e):g.call(e).slice(8,-1)}function m(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function f(e,t){var n=null;return function(e,t){var n=-1,o=e?e.length:0;if("number"==typeof o&&o>-1&&o<=c)for(;++n<o;)t(e[n],n,e);else v(e,t)}(e,function(o,i){n=t(n,o,i,e)}),n}function b(e){return String(e).replace(/^ +| +$/g,"")}var C=function e(t){var n=o,i=t&&"object"==typeof t&&"String"!=u(t);i&&(n=t,t=null);var a=n.navigator||{},r=a.userAgent||"";t||(t=r);var c,l,d,h,C,E=i?!!a.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(g.toString()),S="Object",y=i?S:"ScriptBridgingProxyObject",M=i?S:"Environment",x=i&&n.java?"JavaPackage":u(n.java),R=i?S:"RuntimeObject",L=/\bJava/.test(x)&&n.java,w=L&&u(n.environment)==M,O=L?"a":"α",k=L?"b":"β",I=n.document||{},T=n.operamini||n.opera,A=s.test(A=i&&T?T["[[Class]]"]:u(T))?A:T=null,F=t,P=[],V=null,B=t==r,N=B&&T&&"function"==typeof T.version&&T.version(),j=f([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,n){return e||RegExp("\\b"+(n.pattern||m(n))+"\\b","i").exec(t)&&(n.label||n)}),W=f(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"],function(e,n){return e||RegExp("\\b"+(n.pattern||m(n))+"\\b","i").exec(t)&&(n.label||n)}),D=H([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),G=f({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}},function(e,n,o){return e||(n[D]||n[/^[a-z]+(?: +[a-z]+\b)*/i.exec(D)]||RegExp("\\b"+m(o)+"(?:\\b|\\w*\\d)","i").exec(t))&&o}),$=f(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "],function(e,n){var o,i,a,r,c=n.pattern||m(n);return!e&&(e=RegExp("\\b"+c+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(o=e,i=c,a=n.label||n,r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"},i&&a&&/^Win/i.test(o)&&!/^Windows Phone /i.test(o)&&(r=r[/[\d.]+$/.exec(o)])&&(o="Windows "+r),o=String(o),i&&a&&(o=o.replace(RegExp(i,"i"),a)),e=o=p(o.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])),e});function H(e){return f(e,function(e,n){var o=n.pattern||m(n);return!e&&(e=RegExp("\\b"+o+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+o+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+o+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(n.label&&!RegExp(o,"i").test(n.label)?n.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),n=n.label||n,e=p(e[0].replace(RegExp(o,"i"),n).replace(RegExp("; *(?:"+n+"[_-])?","i")," ").replace(RegExp("("+n+")[-_.]?(\\w)","i"),"$1 $2"))),e})}if(j&&(j=[j]),G&&!D&&(D=H([G])),(c=/\bGoogle TV\b/.exec(D))&&(D=c[0]),/\bSimulator\b/i.test(t)&&(D=(D?D+" ":"")+"Simulator"),"Opera Mini"==W&&/\bOPiOS\b/.test(t)&&P.push("running in Turbo/Uncompressed mode"),"IE"==W&&/\blike iPhone OS\b/.test(t)?(G=(c=e(t.replace(/like iPhone OS/,""))).manufacturer,D=c.product):/^iP/.test(D)?(W||(W="Safari"),$="iOS"+((c=/ OS ([\d_]+)/i.exec(t))?" "+c[1].replace(/_/g,"."):"")):"Konqueror"!=W||/buntu/i.test($)?G&&"Google"!=G&&(/Chrome/.test(W)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(D))||/\bAndroid\b/.test($)&&/^Chrome/.test(W)&&/\bVersion\//i.test(t)?(W="Android Browser",$=/\bAndroid\b/.test($)?$:"Android"):"Silk"==W?(/\bMobi/i.test(t)||($="Android",P.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&P.unshift("accelerated")):"PaleMoon"==W&&(c=/\bFirefox\/([\d.]+)\b/.exec(t))?P.push("identifying as Firefox "+c[1]):"Firefox"==W&&(c=/\b(Mobile|Tablet|TV)\b/i.exec(t))?($||($="Firefox OS"),D||(D=c[1])):!W||(c=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(W))?(W&&!D&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(c+"/")+8))&&(W=null),(c=D||G||$)&&(D||G||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test($))&&(W=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test($)?$:c)+" Browser")):"Electron"==W&&(c=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&P.push("Chromium "+c):$="Kubuntu",N||(N=f(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",m(W),"(?:Firefox|Minefield|NetFront)"],function(e,n){return e||(RegExp(n+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null})),(c=("iCab"==j&&parseFloat(N)>3?"WebKit":/\bOpera\b/.test(W)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(j)&&"WebKit"||!j&&/\bMSIE\b/i.test(t)&&("Mac OS"==$?"Tasman":"Trident")||"WebKit"==j&&/\bPlayStation\b(?! Vita\b)/i.test(W)&&"NetFront")&&(j=[c]),"IE"==W&&(c=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(W+=" Mobile",$="Windows Phone "+(/\+$/.test(c)?c:c+".x"),P.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(W="IE Mobile",$="Windows Phone 8.x",P.unshift("desktop mode"),N||(N=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=W&&"Trident"==j&&(c=/\brv:([\d.]+)/.exec(t))&&(W&&P.push("identifying as "+W+(N?" "+N:"")),W="IE",N=c[1]),B){if(h="global",C=null!=(d=n)?typeof d[h]:"number",/^(?:boolean|number|string|undefined)$/.test(C)||"object"==C&&!d[h])u(c=n.runtime)==y?(W="Adobe AIR",$=c.flash.system.Capabilities.os):u(c=n.phantom)==R?(W="PhantomJS",N=(c=c.version||null)&&c.major+"."+c.minor+"."+c.patch):"number"==typeof I.documentMode&&(c=/\bTrident\/(\d+)/i.exec(t))?(N=[N,I.documentMode],(c=+c[1]+4)!=N[1]&&(P.push("IE "+N[1]+" mode"),j&&(j[1]=""),N[1]=c),N="IE"==W?String(N[1].toFixed(1)):N[0]):"number"==typeof I.documentMode&&/^(?:Chrome|Firefox)\b/.test(W)&&(P.push("masking as "+W+" "+N),W="IE",N="11.0",j=["Trident"],$="Windows");else if(L&&(F=(c=L.lang.System).getProperty("os.arch"),$=$||c.getProperty("os.name")+" "+c.getProperty("os.version")),w){try{N=n.require("ringo/engine").version.join("."),W="RingoJS"}catch(e){(c=n.system)&&c.global.system==n.system&&(W="Narwhal",$||($=c[0].os||null))}W||(W="Rhino")}else"object"==typeof n.process&&!n.process.browser&&(c=n.process)&&("object"==typeof c.versions&&("string"==typeof c.versions.electron?(P.push("Node "+c.versions.node),W="Electron",N=c.versions.electron):"string"==typeof c.versions.nw&&(P.push("Chromium "+N,"Node "+c.versions.node),W="NW.js",N=c.versions.nw)),W||(W="Node.js",F=c.arch,$=c.platform,N=(N=/[\d.]+/.exec(c.version))?N[0]:null));$=$&&p($)}if(N&&(c=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(N)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(B&&a.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(V=/b/i.test(c)?"beta":"alpha",N=N.replace(RegExp(c+"\\+?$"),"")+("beta"==V?k:O)+(/\d+\+?/.exec(c)||"")),"Fennec"==W||"Firefox"==W&&/\b(?:Android|Firefox OS)\b/.test($))W="Firefox Mobile";else if("Maxthon"==W&&N)N=N.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(D))"Xbox 360"==D&&($=null),"Xbox 360"==D&&/\bIEMobile\b/.test(t)&&P.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(W)&&(!W||D||/Browser|Mobi/.test(W))||"Windows CE"!=$&&!/Mobi/i.test(t))if("IE"==W&&B)try{null===n.external&&P.unshift("platform preview")}catch(e){P.unshift("embedded")}else(/\bBlackBerry\b/.test(D)||/\bBB10\b/.test(t))&&(c=(RegExp(D.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||N)?($=((c=[c,/BB10/.test(t)])[1]?(D=null,G="BlackBerry"):"Device Software")+" "+c[0],N=null):this!=v&&"Wii"!=D&&(B&&T||/Opera/.test(W)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==W&&/\bOS X (?:\d+\.){2,}/.test($)||"IE"==W&&($&&!/^Win/.test($)&&N>5.5||/\bWindows XP\b/.test($)&&N>8||8==N&&!/\bTrident\b/.test(t)))&&!s.test(c=e.call(v,t.replace(s,"")+";"))&&c.name&&(c="ing as "+c.name+((c=c.version)?" "+c:""),s.test(W)?(/\bIE\b/.test(c)&&"Mac OS"==$&&($=null),c="identify"+c):(c="mask"+c,W=A?p(A.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(c)&&($=null),B||(N=null)),j=["Presto"],P.push(c));else W+=" Mobile";(c=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(c=[parseFloat(c.replace(/\.(\d)$/,".0$1")),c],"Safari"==W&&"+"==c[1].slice(-1)?(W="WebKit Nightly",V="alpha",N=c[1].slice(0,-1)):N!=c[1]&&N!=(c[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(N=null),c[1]=(/\bChrome\/([\d.]+)/i.exec(t)||0)[1],537.36==c[0]&&537.36==c[2]&&parseFloat(c[1])>=28&&"WebKit"==j&&(j=["Blink"]),B&&(E||c[1])?(j&&(j[1]="like Chrome"),c=c[1]||((c=c[0])<530?1:c<532?2:c<532.05?3:c<533?4:c<534.03?5:c<534.07?6:c<534.1?7:c<534.13?8:c<534.16?9:c<534.24?10:c<534.3?11:c<535.01?12:c<535.02?"13+":c<535.07?15:c<535.11?16:c<535.19?17:c<536.05?18:c<536.1?19:c<537.01?20:c<537.11?"21+":c<537.13?23:c<537.18?24:c<537.24?25:c<537.36?26:"Blink"!=j?"27":"28")):(j&&(j[1]="like Safari"),c=(c=c[0])<400?1:c<500?2:c<526?3:c<533?4:c<534?"4+":c<535?5:c<537?6:c<538?7:c<601?8:"8"),j&&(j[1]+=" "+(c+="number"==typeof c?".x":/[.+]/.test(c)?"":"+")),"Safari"==W&&(!N||parseInt(N)>45)&&(N=c)),"Opera"==W&&(c=/\bzbov|zvav$/.exec($))?(W+=" ",P.unshift("desktop mode"),"zvav"==c?(W+="Mini",N=null):W+="Mobile",$=$.replace(RegExp(" *"+c+"$"),"")):"Safari"==W&&/\bChrome\b/.exec(j&&j[1])&&(P.unshift("desktop mode"),W="Chrome Mobile",N=null,/\bOS X\b/.test($)?(G="Apple",$="iOS 4.3+"):$=null),N&&0==N.indexOf(c=/[\d.]+$/.exec($))&&t.indexOf("/"+c+"-")>-1&&($=b($.replace(c,""))),j&&!/\b(?:Avant|Nook)\b/.test(W)&&(/Browser|Lunascape|Maxthon/.test(W)||"Safari"!=W&&/^iOS/.test($)&&/\bSafari\b/.test(j[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(W)&&j[1])&&(c=j[j.length-1])&&P.push(c),P.length&&(P=["("+P.join("; ")+")"]),G&&D&&D.indexOf(G)<0&&P.push("on "+G),D&&P.push((/^on /.test(P[P.length-1])?"":"on ")+D),$&&(c=/ ([\d.+]+)$/.exec($),l=c&&"/"==$.charAt($.length-c[0].length-1),$={architecture:32,family:c&&!l?$.replace(c[0],""):$,version:c?c[1]:null,toString:function(){var e=this.version;return this.family+(e&&!l?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(c=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(F))&&!/\bi686\b/i.test(F)?($&&($.architecture=64,$.family=$.family.replace(RegExp(" *"+c),"")),W&&(/\bWOW64\b/i.test(t)||B&&/\w(?:86|32)$/.test(a.cpuClass||a.platform)&&!/\bWin64; x64\b/i.test(t))&&P.unshift("32-bit")):$&&/^OS X/.test($.family)&&"Chrome"==W&&parseFloat(N)>=39&&($.architecture=64),t||(t=null);var J={};return J.description=t,J.layout=j&&j[0],J.manufacturer=G,J.name=W,J.prerelease=V,J.product=D,J.ua=t,J.version=W&&N,J.os=$||{architecture:null,family:null,version:null,toString:function(){return"null"}},J.parse=e,J.toString=function(){return this.description||""},J.version&&P.unshift(N),J.name&&P.unshift(W),$&&W&&($!=String($).split(" ")[0]||$!=W.split(" ")[0]&&!D)&&P.push(D?"("+$+")":"on "+$),P.length&&(J.description=P.join(" ")),J}();i&&a?v(C,function(e,t){i[t]=e}):o.platform=C}).call(commonjsGlobal)}),configure={rtc:{iceServers:[{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.l.google.com:19302"}],localStream:void 0,localVideo:void 0},signalingServer:{url:"wss://signal.remotemonster.com/ws"},appServer:{url:"https://signal.remotemonster.com/rest"},sdk:{logLevel:void 0,country:void 0},credential:{key:void 0,serviceId:void 0},view:{local:void 0,remote:void 0},media:{video:!0,audio:!0}};class Context1{constructor(){this.token,this.channel={name:void 0,peers:[],serviceId:void 0,startTime:void 0,status:void 0,type:void 0,id:void 0,msType:"Ms"},this.peers=[],this.localVideo,this.localStream,this.videoCodec,this.audioCodec,this.remoteVideo,this.remoteStream,this.devices,this.isCaller,this.startTime,this.endTime,this.serviceId,this.peerConnection,this.signalingConnection,this.state,this.hasAddTrack,this.eventManager,this.health,this.useVideo=!0,this.useAudio=!0,this.currentVideoDeviceId,this.useRecord=!1,this.remoteRecorder,this.localRecorder,this.mediaManager,this.hasLocalStream=!1,this.isConnectToSignal=!1,this.broadcast=!1,this.videoBandwith,this.audioBandwith}}const logger=function(){const e="[RM]",t=["SILENT","ERROR","WARN","INFO","DEBUG","VERBOSE"];let n;var o;return Object.freeze({init:function(e){if(!t.includes(e.logLevel))throw new Error("Logger:UnmatchedLogLevel");o=e,n=e.logLevel},e:function(...t){if("SILENT"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.error(e+"E>",...t)},w:function(...t){if("SILENT"!==n&&"ERROR"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.warn(e+"W>",...t)},g:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.group(e+"G>",...t)},gEnd:function(){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return console.groupEnd()},l:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.info(e+"I>",...t)},i:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.info(e+"I>",...t)},d:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n&&"INFO"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.debug(e+"D>",...t)},v:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n&&"INFO"!==n&&"DEBUG"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.debug(e+"V>",...t)}})}(),util=function(){return Object.freeze({validateConfig:function(e,t){const n=Object.seal({credential:{key:void 0,serviceId:void 0}});Object.keys(n).forEach(e=>{Object.keys(n[e]).forEach(o=>{t[e][o]?n[e][o]=!0:n[e][o]=!1})}),Object.keys(n).forEach(t=>{Object.keys(n[t]).forEach(o=>{!1===n[t][o]&&e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","InvalidParameterError")})})},bind:function(e,t){if(!e||!t)throw new Error("Failed to execute 'bind' on 'utils': 2 arguments required, but only "+arguments.length+" present.");return function(){e.apply(t,Array.prototype.slice.call(arguments))}},buildMessage:function(e,t,n){var o="\r\n",i=[],a="";a+="Content-Disposition: form-data; ",a+='name=files"; ',a+='filename="'+e+'"'+o,a+="Content-Type: application/octet-stream",a+=o+o,a+=t+o,i.push(a);var r="--"+n+o;return r+=i.join("--"+n+o),r+="--"+n+"--"+o},setMediaBitrate:function(e,t,n){for(var o=e.split("\n"),i=-1,a=0;a<o.length;a++)if(0===o[a].indexOf("m="+t)){i=a;break}if(-1===i)return console.debug("Could not find the m line for",t),e;for(console.debug("Found the m line for",t,"at line",i),i++;0===o[i].indexOf("i=")||0===o[i].indexOf("c=");)i++;if(0===o[i].indexOf("b"))return console.debug("Replaced b line at line",i),o[i]="b=AS:"+n,o.join("\n");console.debug("Adding new b line before line",i);var r=o.slice(0,i);return r.push("b=AS:"+n),(r=r.concat(o.slice(i,o.length))).join("\n")},getVideoFractionLostRating:function(e){return e<40?1:e<55?2:e<70?3:e<90?4:5},getAudioFractionLostRating:function(e){return e<50?1:e<150?2:e<250?3:e<350?4:5}})}();class RemonRecorder{constructor(e,t,n){this.context=e,this.isStart=!1,this.stream=t,this.type="Firefox"===platform.name?"audio/ogg":"audio/webm",this.recorder=new MediaRecorder(this.stream,{audioBitsPerSecond:8192,videoBitsPerSecond:16e3,mimeType:this.type}),this.array=[],this.recorder.ondataavailable=(e=>{this.array.push(e.data)}),this.recorder.onstop=(e=>{var t=new Blob(this.array,{type:this.type}),o=new XMLHttpRequest;o.open("POST",this.context.recordUrl,!0),o.setRequestHeader("X-FILENAME",this.context.serviceId+"."+this.context.channel.id+n+".ogg"),o.onload=function(e){logger.d("upload is completed")},o.send(t)})}start(){this.isStart=!0,this.recorder.start(3e3)}stop(){this.isStart&&this.recorder.stop()}}class Media{constructor(e){this.context=e}bindLocalStreamToPeerConnection(e){0==this.context.useVideo&&0==this.context.useAudio||(this.context.hasAddTrack?(configure.rtc.localStream.getTracks().forEach(t=>e.addTrack(t,configure.rtc.localStream)),logger.d("Local stream added:",e.getSenders())):(e.addStream(configure.rtc.localStream),logger.i("Local stream added:",e.getLocalStreams())),this.context.eventManager.hasEventListener("onAddLocalStream")&&this.context.eventManager.dispatchEvent("onAddLocalStream",configure.rtc.localStream))}gotDevicesInfo(e){this.context.devices=e}isLocalPrepared(){return 0==configure.media.audio&&0==configure.media.video||(!configure.rtc.localVideo||!!configure.rtc.localVideo.srcObject)}async createLocalStream(e,t){var n,o;if((0!=t.audio||0!=t.video)&&e){if(configure.view.localStream)return configure.rtc.localStream=configure.view.localStream,void(e.hasLocalStream=!0);try{try{o=await navigator.mediaDevices.getUserMedia(t)}catch(e){console.log(e)}if(null!==configure.rtc.localVideo&&void 0!==configure.rtc.localVideo){logger.d("type of localvideo: "+typeof configure.rtc.localVideo),logger.d("localvideo: "+configure.rtc.localVideo),logger.d("stream: "+o);try{configure.rtc.localVideo.srcObject=o}catch(e){console.log(e)}}configure.rtc.localStream=o,e.eventManager.dispatchEvent("onDisplayUserMedia",configure.rtc.localStream),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","LOCALMEDIA"),e.hasLocalStream=!0,e.isConnectToSignal&&e.eventManager.hasEventListener("onInit")&&e.eventManager.dispatchEvent("onInit",e.token),logger.i("config stream"+configure.rtc.localStream),e.useRecord&&(e.localRecorder=new RemonRecorder(e,o,"LL"));try{n=await navigator.mediaDevices.enumerateDevices()}catch(e){console.log(e)}e.devices=n,e.currentVideoDeviceId=n[0].deviceId}catch(t){e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","UserMediaDeviceFailedError"),logger.e(error)}}}bindRemoteStreamToView(e){let t;logger.g("Media: Bind remote stream: Bind remote media to video element and regist to context"),logger.d("event:",e),t=this.context.hasAddTrack?e.streams[0]:e.stream,logger.d("Stream:",t),this.context.remoteVideo.srcObject=t,this.context.remoteStream=t,logger.gEnd()}mediaStreamTrackSwitch(e){let t;return Object.freeze({type:function(e){if("Video"!==e&&"Audio"!==e)throw new Error("MediaStreamSwitcher:InvailedMediaType");return t=`get${e}Tracks`,this},enabled:function(n){switch(n){case!0:e[t]().forEach(e=>{e.enabled=!0});break;case!1:e[t]().forEach(e=>{e.enabled=!1});break;default:throw new Error("MediaStreamSwitcher:InvalidCommand")}}})}setAudioOutput(e){configure.rtc.localVideo||configure.rtc.localVideo.setSinkId(e).then(()=>{logger.d("Devices: Audio output device attached success:",e)}).catch(()=>{logger.e("Devices: Audio output device attached failed:",e)})}setUserDevices({audioSource:e,videoSource:t}){window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),createLocalStream({audio:{deviceId:e?{exact:e}:void 0},video:{deviceId:t?{exact:t}:void 0}})}}function EventManager(){const e=["onInit","onConnectChannel","onCreateChannel","onComplete","onConnect","onDisplayUserMedia","onAddLocalStream","onAddRemoteStream","onStateChange","onDisconnectChannel","onMessage","onError","onStat","onSearch","onClose","onLog","onJoin","onCreate"],t=new Map(e.map(e=>[e]));return Object.freeze({addEventListener:function({type:n,listenerItem:o}){if("function"!=typeof o)throw new Error("EventManager:listenerMustBeAFunction");if(!e.includes(n))throw new Error("EventManager:UnmatchedEvent");t.set(n,o)},hasEventListener:function(n){if(e.includes(n))return void 0!==t.get(n);throw new Error("EventManager:UnmatchedEvent")},removeEventListener:function(n){if(!e.includes(n)||!t.has(n))throw new Error("EventManager:UnmatchedEventOrDidNotContainAnylistener");t.set(n,void 0)},getEventListeners:function(){return t},dispatchEvent:function(n,...o){if(e.includes(n))return void 0===t.get(n)?void 0:t.get(n)(...o);throw new Error("EventManager:UnmatchedEvent")}})}const signalingStates=Object.freeze(["INIT","WAIT","CONNECT","COMPLETE","CLOSE","EXIT","FAIL"]);class Health{constructor(e){this.interval=5e3,this.statsReportTimer=null,this.context=e,this.oldStats=null,this.result=null,this.fractionLost={audio:[{rating:1,fromFractionLost:0,toFractionLost:50},{rating:2,fromFractionLost:51,toFractionLost:150},{rating:3,fromFractionLost:151,toFractionLost:250},{rating:4,fromFractionLost:251,toFractionLost:350},{rating:5,fromFractionLost:351,toFractionLost:9999999}],video:[{rating:1,fromFractionLost:0,toFractionLost:40},{rating:2,fromFractionLost:41,toFractionLost:55},{rating:3,fromFractionLost:56,toFractionLost:70},{rating:4,fromFractionLost:71,toFractionLost:90},{rating:5,fromFractionLost:91,toFractionLost:9999999}]}}stop(){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null)}start(){!0!==this.context.isCaller&&(logger.i("Health is start w/interval:"+this.interval),this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null),this.statsReportTimer=window.setInterval(util.bind(function(){this.getStats(util.bind(function(e){var t,n,o,i=0,a=0,r=null,c={localCandidate:"",remoteCandidate:"",localFrameWidth:0,localFrameHeight:0,remoteFrameWidth:0,remoteFrameHeight:0,localFrameRate:0,remoteFrameRate:0,availableSendBandwidth:0,availableReceiveBandwidth:0,rtt:0,rttRating:"",rating:0,localAudioFractionLost:0,localVideoFractionLost:0,localAudioFractionRating:0,localVideoFractionRating:0,remoteAudioFractionLost:0,remoteVideoFractionLost:0,remoteAudioFractionRating:0,remoteVideoFractionRating:0,fractionRating:0,localAudioPacketsLost:0,remoteAudioPaketsLost:0,localVideoPacketsLost:0,remoteVideoPacketsLost:0},s=0,l=0,d=0,g=0,h=0,p=0,v=0,u=0,m=0,f=0,b=0,C=0,E=0,S=0,y=0,M=0,x=this.oldStats;if("Firefox"===platform.name){for(r in e)"candidatepair"!==e[r].type||!0!==e[r].selected?"inboundrtp"!==e[r].type||"audio"!==e[r].mediaType||!0!==e[r].isRemote?"inboundrtp"!==e[r].type||"video"!==e[r].mediaType||!0!==e[r].isRemote||(e[r].hasOwnProperty("mozRtt")&&(n=e[r].mozRtt),e[r].hasOwnProperty("packetsLost")&&(f=e[r].packetsLost),e[r].hasOwnProperty("packetsReceived")&&(C=e[r].packetsReceived)):(e[r].hasOwnProperty("mozRtt")&&(t=e[r].mozRtt),e[r].hasOwnProperty("packetsLost")&&(m=e[r].packetsLost),e[r].hasOwnProperty("packetsReceived")&&(b=e[r].packetsReceived)):(c.localCandidate=e[e[r].localCandidateId].candidateType,c.remoteCandidate=e[e[r].remoteCandidateId].candidateType);for(r in x)"inboundrtp"!==e[r].type||"audio"!==e[r].mediaType||!0!==e[r].isRemote?"inboundrtp"!==e[r].type||"video"!==e[r].mediaType||!0!==e[r].isRemote||(e[r].hasOwnProperty("packetsLost")&&(S=e[r].packetsLost),e[r].hasOwnProperty("packetsReceived")&&(M=e[r].packetsReceived)):(e[r].hasOwnProperty("packetsLost")&&(E=e[r].packetsLost),e[r].hasOwnProperty("packetsReceived")&&(y=e[r].packetsReceived));!1===this.context.useVideo?c.rtt=t:c.rtt=n}else{if("Chrome"!==platform.name)return;for(a=e.length;i<a;i++)"true"!==e[i].googActiveConnection?e[i].hasOwnProperty("audioInputLevel")?(s=parseInt(e[i].packetsLost),d=parseInt(e[i].packetsSent),!1===this.context.useVideo&&(c.rtt=parseInt(e[i].googRtt))):e[i].hasOwnProperty("googFrameWidthSent")?(c.localFrameWidth=parseInt(e[i].googFrameWidthSent),c.localFrameHeight=parseInt(e[i].googFrameHeightSent),c.localFrameRate=parseInt(e[i].googFrameRateSent),l=parseInt(e[i].packetsLost),g=parseInt(e[i].packetsSent),!0===this.context.useVideo&&(c.rtt=parseInt(e[i].googRtt))):e[i].hasOwnProperty("audioOutputLevel")?(m=parseInt(e[i].packetsLost),b=parseInt(e[i].packetsReceived)):e[i].hasOwnProperty("googFrameWidthReceived")?(c.remoteFrameWidth=parseInt(e[i].googFrameWidthReceived),c.remoteFrameHeight=parseInt(e[i].googFrameHeightReceived),c.remoteFrameRate=parseInt(e[i].googFrameRateReceived),f=parseInt(e[i].packetsLost),C=parseInt(e[i].packetsReceived)):e[i].hasOwnProperty("googAvailableSendBandwidth")&&(c.availableSendBandwidth=parseInt(e[i].googAvailableSendBandwidth),c.availableReceiveBandwidth=parseInt(e[i].googAvailableReceiveBandwidth)):(c.localCandidate=e[i].googLocalCandidateType,c.remoteCandidate=e[i].googRemoteCandidateType);for(i=0;i<x.length;i++)x[i].hasOwnProperty("audioInputLevel")?(h=parseInt(x[i].packetsLost),v=parseInt(x[i].packetsSent)):x[i].hasOwnProperty("googFrameWidthSent")?(p=parseInt(x[i].packetsLost),u=parseInt(x[i].packetsSent)):x[i].hasOwnProperty("audioOutputLevel")?(E=parseInt(x[i].packetsLost),y=parseInt(x[i].packetsReceived)):x[i].hasOwnProperty("googFrameWidthReceived")&&(S=parseInt(x[i].packetsLost),M=parseInt(x[i].packetsReceived))}var R=parseInt((s-h)/(d-v)*255||0),L=parseInt((l-p)/(g-u)*255||0);c.localAudioPacketsLost=parseInt((s-h)/this.interval),c.localVideoPacketsLost=parseInt((l-p)/this.interval),c.remoteAudioPacketsLost=parseInt((m-E)/this.interval),c.remoteVideoPacketsLost=parseInt((f-S)/this.interval),c.localAudioFractionLost=R,c.localVideoFractionLost=L,c.localAudioFractionRating=util.getAudioFractionLostRating(R,this.fractionLost.audio),c.localVideoFractionRating=util.getVideoFractionLostRating(L,this.fractionLost.video);var w=parseInt((m-E)/(b-y)*255||0),O=parseInt((f-S)/(C-M)*255||0);c.remoteAudioFractionLost=w,c.remoteVideoFractionLost=O,c.remoteAudioFractionRating=util.getAudioFractionLostRating(w,this.fractionLost.audio),c.remoteVideoFractionRating=util.getVideoFractionLostRating(O,this.fractionLost.video),c.fractionRating=c.remoteVideoFractionRating,c.rttRating=this.getRttRating(c.rtt),c.rating=this.getMaxRating(c.rttRating,c.remoteAudioFractionRating,c.remoteVideoFractionRating,c.localAudioFractionRating,c.localVideoFractionRating),this.oldStats=e,this.result=c,this.context.eventManager.hasEventListener("onStat")&&this.context.eventManager.dispatchEvent("onStat",c),(o=this.context.signalingConnection.createMessage({command:"health",body:JSON.stringify(c)}))&&(this.context.database||this.context.signalingConnection.send(JSON.stringify(o)))},this))},this),this.interval))}getMaxRating(){var e=0,t=0;for(e=0;e<arguments.length;e++)arguments[e]>t&&(t=arguments[e]);return t}getRttRating(e){var t=0;return e>=1e3?t=5:e>=800?t=4:e>=600?t=3:e>=400?t=2:e<400&&(t=1),t}getVideoFractionLostRating(e){return e<40?1:e<55?2:e<70?3:e<90?4:5}getAudioFractionLostRating(e){return e<50?1:e<150?2:e<250?3:e<350?4:5}getFractionLostRating(e,t){var n=t;for(let t=0;t<n.length;t++)if(n[t].fromFractionLost<=e&&n[t].toFractionLost>=e)return n[t].rating;return 1}getStats(e){"Firefox"===platform.name?this.context.peerConnection.getStats(null,util.bind(function(t){e.call(this,t)},this),function(){}):this.context.peerConnection.getStats(util.bind(function(t){var n=[];t.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),e.call(this,n)},this))}}var WORKER_ENABLED=!!(commonjsGlobal===commonjsGlobal.window&&commonjsGlobal.URL&&commonjsGlobal.Blob&&commonjsGlobal.Worker);function bindPeerConnectionEvents({context:e,media:t}){function n(){e.health.stop(),e.peerConnection.close(),e.signalingConnection.close(),e.state="CLOSE",e.useRecord&&e.remoteRecorder&&(e.remoteRecorder.stop(),e.remoteRecorder=null),e.useRecord&&e.localRecorder&&(e.localRecorder.stop(),e.localRecorder=null,e.useRecord=!1),e.remoteVideo.srcObject&&e.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),e.remoteVideo&&(e.remoteVideo.srcObject=null),e.signalingConnection&&e.peerConnection&&(e.health&&e.health.stop(),e.hasAddTrack?e.peerConnection.ontrack=null:e.peerConnection.onaddstream=null,e.peerConnection.onremovestream=null,e.peerConnection.onicecandidate=null,e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.onsignalingstatechange=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onnegotiationneeded=null)}function o(t){let n;logger.g("PeerCon: Bind remote stream"),logger.v("bindRemoteStream:",t),e.hasAddTrack?(logger.v("PeerCon: context has track"),n=t.streams[0]):(logger.v("PeerCon: context has stream"),n=t.stream),e.remoteVideo.srcObject=n,e.remoteStream=n,"Safari"!==platform.name&&"safari"!==platform.name||e.remoteVideo.paused&&e.remoteVideo.play(),e.useRecord&&!e.remoteRecorder&&(e.remoteRecorder=new RemonRecorder(e,n,"RR"),e.remoteRecorder.start(),e.localRecorder.start()),logger.gEnd()}e.peerConnection.onicecandidate=function(t){logger.i("PeerCon: HandleICECandidateEvent"),logger.d("Event:",t),logger.d("-> Candidate:",t.candidate);const n=e.signalingConnection.createMessage({command:"ice",body:JSON.stringify(t.candidate)});t.candidate&&(logger.i("Message ->: ",n),"BROADCAST"===e.channel.type&&(n.channel.type="BROADCAST"),void 0===n||e.database||e.signalingConnection.send(JSON.stringify(n)))},e.peerConnection.onicegatheringstatechange=function(){logger.i("PeerCon: Handle ice gathering state event"),logger.d(`Event: ${e.peerConnection.iceGatheringState}:`,event)},e.peerConnection.onsignalingstatechange=function(t){switch(logger.i("PeerCon: Handle signaling state change event"),logger.d(`Event: ${e.peerConnection.signalingState}:`,t),e.peerConnection.signalingState){case"stable":e.endTime=(new Date).getTime(),e.eventManager.hasEventListener("onAddRemoteStream")&&e.eventManager.dispatchEvent("onAddRemoteStream",e.remoteStream);break;case"have-local-offer":case"have-remote-offer":case"have-local-pranswer":case"have-remote-pranswer":case"closed":break;default:logger.e("Unknown signaling state event:",e.peerConnection.signalingState)}},e.peerConnection.onnegotiationneeded=function(e){logger.d("PeerCon: Handle negotiation needed event"),logger.d("Event:",e)},e.peerConnection.oniceconnectionstatechange=function(t){let o;switch(logger.i("PeerCon: Handle ICE state change event"),logger.i(`Event: ${e.peerConnection.iceConnectionState}:`,t),e.peerConnection.iceConnectionState){case"connected":logger.i("ice State:connected"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","COMPLETE"),e.eventManager.hasEventListener("onComplete")&&e.eventManager.dispatchEvent("onComplete"),o=e.signalingConnection.createMessage({command:"stateChange",body:"COMPLETE"});var i=new Health(e);if(i.getStats(util.bind(function(e){this.oldStats=e},i)),i.start(),e.health=i,"BROADCAST"===e.channel.type||"VIEWER"===e.channel.type)return;break;case"failed":logger.i("ice State:failed"),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","ICEFailedError"),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose","ICEFailedError"),logger.e("Ice connection state change failed"),"CLOSE"!==e.state&&n();break;case"closed":return void logger.i("ice State:closed");case"disconnected":return logger.i("ice State:disconnected"),o=e.signalingConnection.createMessage({command:"stateChange",body:"CLOSE"}),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose","ICEFailedError"),logger.e("Ice connection state change failed"),void("CLOSE"!==e.state&&n());case"completed":logger.v("iceconState:completed");break;case"checking":logger.v("iceconState:checking");break;default:logger.e("Unknown ice connection change event:",e.peerConnection.iceConnectionState)}logger.v("Message ->:",o),logger.i("Sending ice state to other"),void 0!==o&&e.signalingConnection.send(JSON.stringify(o))},e.hasAddTrack?(logger.i("PeerCon: context has addTrack"),e.peerConnection.ontrack=o):(logger.i("PeerCon: context has onAddstream"),e.peerConnection.onaddstream=o),e.peerConnection.onremovestream=function(e){logger.v("PeerCon: Handle remove stream event")}}async function SignalingConnection({url:e,context:t}){const n=await function(){logger.d("Signaling: Connect");const t=new WebSocket(e);return logger.d("Signaling Connection: ",t),t}();var o=!1;function i(...e){return n.send(...e)}function a({command:e,body:n}){logger.d("Signaling: Create Message %j",n);const o={command:e,token:t.token,serviceId:t.serviceId,channel:{id:t.channel.id,name:t.channel.name,type:t.channel.type}};return n&&(o.body=n),logger.v("createMessage: "+JSON.stringify(o)),o}return n.onopen=async function(e){logger.i("Signaling: Success connect to the signaling server"),logger.v("OpenEvent:",e),o=!0,t.isConnectToSignal=!0,t.eventManager.hasEventListener("onInit")&&t.eventManager.dispatchEvent("onInit",t.token),t.eventManager.hasEventListener("onStateChange")&&t.eventManager.dispatchEvent("onStateChange","INIT"),!0!==configure.media.recvonly&&(logger.d("try to create local stream"),await t.mediaManager.createLocalStream(t,configure.media),t.mediaManager.bindLocalStreamToPeerConnection(t.peerConnection),logger.d("success to create and bind local stream to pc"))},n.onclose=function(e){logger.i("Signaling: Closed the signaling connection"),logger.v("Event:",e),o=!1},n.onerror=function(e){logger.i("Signaling: Error from the signaling connection."),logger.v("Event",e),t.eventManager.hasEventListener("onError")&&t.eventManager.dispatchEvent("onError","WebSocketFailedError"),o=!1},Object.freeze({connectChannel:function(e){logger.i("Signaling: Connect channel: As a caller"),t.startTime=(new Date).getTime(),t.isCaller=!0,t.channel.id=e;const n=a({command:"connect"});logger.v("ConnectCh Message ->:",n),i(JSON.stringify(n))},createMessage:a,createViewerChannel:function(e){logger.i("Signaling: Create channel: As a viewer"),t.startTime=(new Date).getTime(),t.isCaller=!1,t.channel.id=e;const n=a({command:"create"});n.channel.type="VIEWER",n.channel.id=e,logger.v("ConnectCh Message ->:",n),i(JSON.stringify(n))},createBroadcastChannel:function(e){logger.i("Signaling: Create channel: As a presenter"),t.startTime=(new Date).getTime(),t.isCaller=!1,t.channel.name=e;const n=a({command:"create"});n.channel.type="BROADCAST",logger.v("ConnectCh Message ->:",n),logger.i("channel id: "+t.channel.id),i(JSON.stringify(n))},send:i,close:function(){if(n.readyState<2){const e=a({command:"disconnect"});logger.v("disconnect Message ->:",e),i(JSON.stringify(e)),n.close(),o=!1}},onMessage:function(e){n.onmessage=e},context:t,setDisconnectHandler:function(){t.channel.type},isOpened:function(){return o}})}function bindSignalingConnectionEvents({context:e,media:t}){const n={onCreate(t){if(logger.i("Signaling: On create channel"),e.isCaller=!1,e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","WAIT"),!t.channel&&e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"Can not make a channel"})}e.channel=t.channel,logger.i("Channel id:",e.channel.id),logger.i("Channel type: ",e.channel.type),e.eventManager.hasEventListener("onCreateChannel")&&e.eventManager.dispatchEvent("onCreateChannel",e.channel.id),e.eventManager.hasEventListener("onConnect")&&"P2P"===e.channel.type&&e.eventManager.dispatchEvent("onConnect",e.channel.id),e.eventManager.hasEventListener("onCreate")&&"BROADCAST"===e.channel.type?e.eventManager.dispatchEvent("onCreate",e.channel.id):e.eventManager.hasEventListener("onJoin")&&"VIEWER"===e.channel.type&&e.eventManager.dispatchEvent("onJoin",e.channel.id),"BROADCAST"===e.channel.type?function(){const t={offerToReceiveAudio:!1,offerToReceiveVideo:!1};"Ms"===e.channel.msType?e.peerConnection.createOffer(t).then(o).catch(t=>{if(logger.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;}):e.peerConnection.createOffer(t).then(i).catch(t=>{if(logger.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})}():"VIEWER"===e.channel.type&&function(){logger.i("createViewerOffer is called "+platform.name);"Safari"!==platform.name&&"safari"!==platform.name||(logger.d("safari mode is on"),e.peerConnection.addTransceiver("video").setDirection("recvonly"));e.peerConnection.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(o).catch(t=>{if(logger.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})}(),logger.gEnd()},onConnect(t){if(logger.i("Signaling: On connect channel"),e.isCaller=!0,e.channel=t.channel,logger.i("Channel id:",e.channel.id),logger.i("Channel type: ",e.channel.type),logger.d("isCaller: true"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","CONNECT"),!t.channel){if(e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"Can not make a channel"})}return}e.eventManager.hasEventListener("onConnectChannel")&&e.eventManager.dispatchEvent("onConnectChannel",e.channel.id);e.peerConnection.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(i).catch(t=>{if(logger.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})},onSdp(t){logger.i("Signaling: On sdp");const n=new RTCSessionDescription(JSON.parse(t.body));logger.i("-> Remote Description:",n),e.videoBandwidth&&(n.sdp=util.setMediaBitrate(n.sdp,"video",e.videoBandwidth)),e.peerConnection.setRemoteDescription(n).then(()=>{logger.i("Remote Description Setted")}).catch(t=>{if(logger.e("PeerConnection: Remote description set failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Remote description set failed"})}else;}),logger.i("Am I a caller?:",e.isCaller),logger.d("channel info?:",e.channel),e.isCaller||"offer"!==n.type||(logger.i("Create answer"),e.peerConnection.createAnswer().then(i).catch(t=>{if(logger.e("PeerConnection: Create Answer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create Answer failed"})}else;})),logger.gEnd()},onDisconnectChannel(t){logger.i("Signaling: onDisconnectChannel"),(t===e.token||"BROADCAST"===e.channel.type&&"room"===t)&&a(),e.eventManager.hasEventListener("onDisconnectChannel")&&e.eventManager.dispatchEvent("onDisconnectChannel",t.body),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose",t.body)},ping(t){t.command="pong",e.signalingConnection.send(JSON.stringify(t))},onStateChange(t){if(signalingStates.includes(t.body))switch(e.state=t.body,e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange",t.body),t.body){case"INIT":logger.i(">STATE:INIT");break;case"WAIT":logger.i(">STATE:WAIT");break;case"CONNECT":logger.i(">STATE:CONNECT");break;case"COMPLETE":logger.i(">STATE:COMPLETE"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","COMPLETE"),e.eventManager.hasEventListener("onComplete")&&e.eventManager.dispatchEvent("onComplete");break;case"CLOSE":logger.i(">STATE:CLOSE"),a(),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","CLOSE"),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose");break;case"FAIL":logger.i(">STATE:FAIL"),a(),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError")}else logger(logger.e("Unknown signaling state:"+t.body));logger.gEnd()},onIce(t){const n=new RTCIceCandidate(JSON.parse(t.body));logger.d("Candidate:",JSON.stringify(n)),e.peerConnection.addIceCandidate(n).then(()=>{logger.d("Add ICE candidate success")}).catch(t=>{if(logger.e("Peer Connection: Add ICE candidate failed",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"Peer Connection: Add ICE candidate failed"})}}),logger.gEnd()},onMessage(t){logger.d("Signaling: On message: "+t.body),e.eventManager.hasEventListener("onMessage")&&e.eventManager.dispatchEvent("onMessage",t.body)},onSearch(t){logger.d("Signaling: On search: "+t.body),e.eventManager.hasEventListener("onSearch")&&e.eventManager.dispatchEvent("onSearch",t.body)},onError(t){logger.e("Signaling error -> Message:",t),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError",t)}};function o(t){logger.i("Local Description:",t),e.videoCodec?(logger.v("Signaling: video codec: "+e.videoCodec),t.sdp=r(t.sdp,/m=video(:?.*)?/,e.videoCodec)):(logger.v("Signaling: video codec: H264"),t.sdp=r(t.sdp,/m=video(:?.*)?/,"H264"));const n=e.signalingConnection.createMessage({command:"sdp",body:JSON.stringify(t)});n.channel.type=e.channel.type,e.signalingConnection.send(JSON.stringify(n))}function i(t){logger.i("new Local Description:",t),e.videoCodec?(logger.v("Signaling: video codec: "+e.videoCodec),t.sdp=r(t.sdp,/m=video(:?.*)?/,e.videoCodec)):(logger.v("Signaling: video codec: H264"),t.sdp=r(t.sdp,/m=video(:?.*)?/,"H264")),e.videoBandwidth&&(t.sdp=util.setMediaBitrate(t.sdp,"video",e.videoBandwidth));const n=e.signalingConnection.createMessage({command:"sdp",body:JSON.stringify(t)});n.channel.type=e.channel.type,e.peerConnection.setLocalDescription(t).then(()=>{logger.v("Local Description Setted:",e.peerConnection.localDescription),logger.i("Message ->:",n),e.signalingConnection.send(JSON.stringify(n))}).catch(t=>{if(logger.e("PeerConnection: set Local description failed",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"PeerConnection: set Local description failed"})}})}function a(){logger.i("close resources"),e.health.stop(),e.peerConnection.close(),e.signalingConnection.close(),e.state="CLOSE",e.useRecord&&e.remoteRecorder&&(e.remoteRecorder.stop(),e.remoteRecorder=null),e.useRecord&&e.localRecorder&&(e.localRecorder.stop(),e.localRecorder=null,e.useRecord=!1),e.remoteVideo.srcObject&&e.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),e.remoteVideo&&(e.remoteVideo.srcObject=null),e.signalingConnection&&e.peerConnection&&(e.health&&e.health.stop(),e.hasAddTrack?e.peerConnection.ontrack=null:e.peerConnection.onaddstream=null,e.peerConnection.onremovestream=null,e.peerConnection.onicecandidate=null,e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.onsignalingstatechange=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onnegotiationneeded=null)}function r(e,t,n){var o,i,a,r=[],c=new RegExp("a=rtpmap:(\\d+) "+n+"/\\d+");if(!(o=e.match(t)))return e;if(!(i=e.match(c)))return e;o=o[0],i=i[1],a=o.split(" "),r.push(a[0]),r.push(a[1]),r.push(a[2]),r.push(i);for(var s=3;s<a.length;s++)a[s]!==i&&r.push(a[s]);return e.replace(o,r.join(" "))}e.signalingConnection.onMessage(function(e){logger.d("Signaling: Got command from server");const t=JSON.parse(e.data),o=t.command;logger.v(`-> Message: ${t.command}:`,t),n[o](t)})}class Remon{constructor({config:e,listener:t}){this.version="2.0.10",this.context=new Context1,this.context.eventManager=EventManager(),this.config=e,util.validateConfig(this.context,this.config),this.media=new Media(this.context),this.context.mediaManager=this.media,this.uri=configure.appServer.url,this.key=this.config.credential.key,this.serviceId=this.config.credential.serviceId,this.context.key=this.key,this.context.serviceId=this.serviceId,this.context.state="INIT",this.context.logLevel=this.config.dev&&this.config.dev.logLevel?this.config.dev.logLevel:"INFO",logger.init(this.context),t&&Object.keys(t).forEach(e=>{const n=t[e];this.context.eventManager.addEventListener({type:e,listenerItem:n})}),this.config.media||(this.config.media={audio:!0,video:!0,record:!1}),this.config.media.record&&(this.context.useRecord=this.config.media.record,this.config.media.recordUrl?this.context.recordUrl=this.config.media.recordUrl:this.context.recordUrl="https://demo.remotemonster.com/rest/record"),configure.media=this.config.media,configure.view=this.config.view,this.config.media.video.codec&&(this.context.videoCodec=this.config.media.video.codec),this.config.media.audio.codec&&(this.context.audioCodec=this.config.media.audio.codec),!1===this.config.media.video&&(this.context.useVideo=!1),!1===this.config.media.audio&&(this.context.useAudio=!1),this.config.media.video.maxBandwidth&&(this.context.videoBandwidth=this.config.media.video.maxBandwidth),this.config.media.audio.maxBandwidth&&(this.context.audioBandwidth=this.config.media.audio.maxBandwidth),this.config.credential.resturl&&(this.config.credential.resturl=this.config.credential.resturl.replace("/init",""),configure.appServer.url=this.config.credential.resturl,this.uri=configure.appServer.url),this.config.credential.wsurl&&(configure.signalingServer.url=this.config.credential.wsurl)}async init(){logger.d("init is called");var e=this.context,t=this.config,n={credential:{key:this.key,serviceId:this.serviceId},env:{os:platform.os.family,osVersion:platform.os.version||"0",device:platform.name,deviceVersion:platform.version||"0",networkType:Navigator.connection,sdkVersion:this.version}};this.config.sdk&&this.config.sdk.country&&(n.env.country=this.config.sdk.country),!0===this.config.media.sendonly&&(n.sendonly="true"),!0===this.config.media.recvonly&&(n.recvonly="true"),this.config.media.roomid&&(n.id=this.config.media.roomid);var o={method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(n)};try{var i=await fetch(this.uri+"/init",o),a=await i.json()}catch(t){e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","WebSocketFailedError"),logger.e("Init: failed:",error)}logger.d("-> Message:",a),Object.keys(a).forEach(t=>{switch(t){case"iceServers":configure.rtc.iceServers=a[t];break;case"token":e.token=a[t];break;case"key":e.channel.id=a[t];break;case"name":e.channel.name=a[t]}}),1!=t.media.sendonly&&1!=t.media.recvonly&&1!=t.media.broadcast||(e.broadcast=!0),e.signalingConnection=await SignalingConnection({url:configure.signalingServer.url,context:e}),1!=t.media.sendonly&&1!=t.media.recvonly&&1!=t.media.broadcast||(1==t.media.sendonly&&(e.channel.type="BROADCAST"),1==t.media.recvonly&&(e.channel.type="VIEWER"),e.signalingConnection.setDisconnectHandler()),e.peerConnection=new RTCPeerConnection(configure.rtc,t.opt),e.hasAddTrack=void 0!==e.peerConnection.addTrack,bindSignalingConnectionEvents({context:e,media:this.media}),bindPeerConnectionEvents({context:e,media:this.media}),e.useVideo&&t.view&&void 0!==t.view.local&&(configure.rtc.localVideo=document.querySelector(`${t.view.local}`)),t.view&&void 0!==t.view.remote&&(e.remoteVideo=document.querySelector(`${t.view.remote}`)),t.media.recvonly&&(e.remoteVideo=document.querySelector(`${t.view.remote}`));for(let t=5;t<=11;t++){if(e.signalingConnection.isOpened()&&e.mediaManager.isLocalPrepared())return;{const e=Math.pow(2,t);logger.v("wating for init %i",t),await this.wait(e)}}e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","WebSocketFailedError")}async connectCall(...e){logger.d("connect is called"),await this.connectChannel(...e)}async connectChannel(...e){return logger.d("createChannel is called"),await this.init(),this.context.signalingConnection.connectChannel(...e)}async createCast(e){logger.d("createCast is called"),await this.init(),this.context.signalingConnection.createBroadcastChannel(e)}async joinCast(e){logger.d("joinCast is called"),await this.init(),this.context.signalingConnection.createViewerChannel(e)}getHealth(){return this.context.health.result}getVersion(){return this.version}getChannelId(){return this.context.channel.id}pauseLocalVideo(e){logger.d("pauseLocalVideo is called"),this.media.mediaStreamTrackSwitch(configure.rtc.localStream).type("Video").enabled(!!e)}pauseRemoteVideo(e){logger.d("pauseRemoteVideo is called"),this.media.mediaStreamTrackSwitch(this.context.remoteStream).type("Video").enabled(!!e)}cameraSwitch(){logger.d("cameraSwitch is called"),this.media.setUserDevices(null,this.context.devices[1].deviceId)}muteLocalAudio(e){this.media.mediaStreamTrackSwitch(configure.rtc.localStream).type("Audio").enabled(!!e)}muteRemoteAudio(e){this.media.mediaStreamTrackSwitch(this.context.remoteStream).type("Audio").enabled(!!e)}async fetchCalls(e){return await this.search(e)}search(e){logger.d("search by"+e);const t={method:"GET",headers:{"Content-Type":"application/json"}};return new Promise((e,n)=>{fetch(this.uri+"/call/"+this.config.credential.serviceId,t).then(t=>{t.json().then(t=>{this.context.eventManager.hasEventListener("onSearch")&&this.context.eventManager.dispatchEvent("onSearch",t),e(t)}).catch(e=>{n(e)})})})}async fetchCasts(){return await this.liveRooms()}liveRooms(){const e={method:"GET",headers:{"Content-Type":"application/json"}};return new Promise((t,n)=>{fetch(this.uri+"/room/"+this.config.credential.serviceId,e).then(e=>{e.json().then(e=>{t(e)}).catch(e=>{n(e)})})})}sendMessage(e){logger.g("Signaling: Send user message");const t=this.context.signalingConnection.createMessage({command:"message",body:e});logger.d("Message ->:",t),this.context.signalingConnection.send(JSON.stringify(t)),logger.gEnd()}close(){logger.i("Remon.close"),this.context.useRecord&&this.context.remoteRecorder&&(this.context.remoteRecorder.stop(),this.context.remoteRecorder=null),this.context.useRecord&&this.context.localRecorder&&(this.context.localRecorder.stop(),this.context.localRecorder=null,this.context.useRecord=!1),this.context.remoteVideo&&this.context.remoteVideo.srcObject&&(this.context.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),this.context.remoteVideo.srcObject=null),configure.rtc.localVideo&&configure.rtc.localVideo.srcObject&&configure.rtc.localVideo.srcObject.getTracks().forEach(e=>e.stop()),this.context.database&&(this.context.database.ref("/msg/peer/"+this.context.token).onDisconnect().remove(),this.context.database.ref("/tokens/"+this.context.serviceId+"/"+this.context.token).onDisconnect().remove()),this.context.signalingConnection&&this.context.peerConnection&&(this.context.health&&this.context.health.stop(),this.context.hasAddTrack?this.context.peerConnection.ontrack=null:this.context.peerConnection.onaddstream=null,this.context.peerConnection.onremovestream=null,this.context.peerConnection.onicecandidate=null,this.context.peerConnection.oniceconnectionstatechange=null,this.context.peerConnection.onsignalingstatechange=null,this.context.peerConnection.onicegatheringstatechange=null,this.context.peerConnection.onnegotiationneeded=null,"closed"!==this.context.peerConnection.signalingState&&this.context.peerConnection.close(),this.context.peerConnection=null,this.context.signalingConnection.close())}wait(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}}export default Remon;
