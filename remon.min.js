!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("webrtc-adapter")):"function"==typeof define&&define.amd?define(["webrtc-adapter"],t):e.Remon=t(e.webrtcAdapter)}(this,function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var n,o=(function(e,n){(function(){var o={function:!0,object:!0},a=o[typeof window]&&window||this,i=o.object&&n,r=o.object&&e&&!e.nodeType&&e,c=i&&r&&"object"==typeof t&&t;!c||c.global!==c&&c.window!==c&&c.self!==c||(a=c);var s=Math.pow(2,53)-1,d=/\bOpera/,l=Object.prototype,h=l.hasOwnProperty,g=l.toString;function p(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function v(e){return e=C(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:p(e)}function u(e,t){for(var n in e)h.call(e,n)&&t(e[n],n,e)}function m(e){return null==e?p(e):g.call(e).slice(8,-1)}function f(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function b(e,t){var n=null;return function(e,t){var n=-1,o=e?e.length:0;if("number"==typeof o&&o>-1&&o<=s)for(;++n<o;)t(e[n],n,e);else u(e,t)}(e,function(o,a){n=t(n,o,a,e)}),n}function C(e){return String(e).replace(/^ +| +$/g,"")}var S=function e(t){var n=a,o=t&&"object"==typeof t&&"String"!=m(t);o&&(n=t,t=null);var i=n.navigator||{},r=i.userAgent||"";t||(t=r);var c,s,l,h,p,S=o?!!i.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(g.toString()),E="Object",y=o?E:"ScriptBridgingProxyObject",M=o?E:"Environment",x=o&&n.java?"JavaPackage":m(n.java),R=o?E:"RuntimeObject",L=/\bJava/.test(x)&&n.java,w=L&&m(n.environment)==M,O=L?"a":"α",k=L?"b":"β",I=n.document||{},T=n.operamini||n.opera,A=d.test(A=o&&T?T["[[Class]]"]:m(T))?A:T=null,F=t,P=[],V=null,B=t==r,N=B&&T&&"function"==typeof T.version&&T.version(),W=b([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,n){return e||RegExp("\\b"+(n.pattern||f(n))+"\\b","i").exec(t)&&(n.label||n)}),j=b(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"],function(e,n){return e||RegExp("\\b"+(n.pattern||f(n))+"\\b","i").exec(t)&&(n.label||n)}),D=H([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),G=b({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}},function(e,n,o){return e||(n[D]||n[/^[a-z]+(?: +[a-z]+\b)*/i.exec(D)]||RegExp("\\b"+f(o)+"(?:\\b|\\w*\\d)","i").exec(t))&&o}),$=b(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "],function(e,n){var o,a,i,r,c=n.pattern||f(n);return!e&&(e=RegExp("\\b"+c+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(o=e,a=c,i=n.label||n,r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"},a&&i&&/^Win/i.test(o)&&!/^Windows Phone /i.test(o)&&(r=r[/[\d.]+$/.exec(o)])&&(o="Windows "+r),o=String(o),a&&i&&(o=o.replace(RegExp(a,"i"),i)),e=o=v(o.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])),e});function H(e){return b(e,function(e,n){var o=n.pattern||f(n);return!e&&(e=RegExp("\\b"+o+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+o+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+o+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(n.label&&!RegExp(o,"i").test(n.label)?n.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),n=n.label||n,e=v(e[0].replace(RegExp(o,"i"),n).replace(RegExp("; *(?:"+n+"[_-])?","i")," ").replace(RegExp("("+n+")[-_.]?(\\w)","i"),"$1 $2"))),e})}if(W&&(W=[W]),G&&!D&&(D=H([G])),(c=/\bGoogle TV\b/.exec(D))&&(D=c[0]),/\bSimulator\b/i.test(t)&&(D=(D?D+" ":"")+"Simulator"),"Opera Mini"==j&&/\bOPiOS\b/.test(t)&&P.push("running in Turbo/Uncompressed mode"),"IE"==j&&/\blike iPhone OS\b/.test(t)?(G=(c=e(t.replace(/like iPhone OS/,""))).manufacturer,D=c.product):/^iP/.test(D)?(j||(j="Safari"),$="iOS"+((c=/ OS ([\d_]+)/i.exec(t))?" "+c[1].replace(/_/g,"."):"")):"Konqueror"!=j||/buntu/i.test($)?G&&"Google"!=G&&(/Chrome/.test(j)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(D))||/\bAndroid\b/.test($)&&/^Chrome/.test(j)&&/\bVersion\//i.test(t)?(j="Android Browser",$=/\bAndroid\b/.test($)?$:"Android"):"Silk"==j?(/\bMobi/i.test(t)||($="Android",P.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&P.unshift("accelerated")):"PaleMoon"==j&&(c=/\bFirefox\/([\d.]+)\b/.exec(t))?P.push("identifying as Firefox "+c[1]):"Firefox"==j&&(c=/\b(Mobile|Tablet|TV)\b/i.exec(t))?($||($="Firefox OS"),D||(D=c[1])):!j||(c=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(j))?(j&&!D&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(c+"/")+8))&&(j=null),(c=D||G||$)&&(D||G||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test($))&&(j=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test($)?$:c)+" Browser")):"Electron"==j&&(c=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&P.push("Chromium "+c):$="Kubuntu",N||(N=b(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",f(j),"(?:Firefox|Minefield|NetFront)"],function(e,n){return e||(RegExp(n+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null})),(c=("iCab"==W&&parseFloat(N)>3?"WebKit":/\bOpera\b/.test(j)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(W)&&"WebKit"||!W&&/\bMSIE\b/i.test(t)&&("Mac OS"==$?"Tasman":"Trident")||"WebKit"==W&&/\bPlayStation\b(?! Vita\b)/i.test(j)&&"NetFront")&&(W=[c]),"IE"==j&&(c=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(j+=" Mobile",$="Windows Phone "+(/\+$/.test(c)?c:c+".x"),P.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(j="IE Mobile",$="Windows Phone 8.x",P.unshift("desktop mode"),N||(N=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=j&&"Trident"==W&&(c=/\brv:([\d.]+)/.exec(t))&&(j&&P.push("identifying as "+j+(N?" "+N:"")),j="IE",N=c[1]),B){if(h="global",p=null!=(l=n)?typeof l[h]:"number",/^(?:boolean|number|string|undefined)$/.test(p)||"object"==p&&!l[h])m(c=n.runtime)==y?(j="Adobe AIR",$=c.flash.system.Capabilities.os):m(c=n.phantom)==R?(j="PhantomJS",N=(c=c.version||null)&&c.major+"."+c.minor+"."+c.patch):"number"==typeof I.documentMode&&(c=/\bTrident\/(\d+)/i.exec(t))?(N=[N,I.documentMode],(c=+c[1]+4)!=N[1]&&(P.push("IE "+N[1]+" mode"),W&&(W[1]=""),N[1]=c),N="IE"==j?String(N[1].toFixed(1)):N[0]):"number"==typeof I.documentMode&&/^(?:Chrome|Firefox)\b/.test(j)&&(P.push("masking as "+j+" "+N),j="IE",N="11.0",W=["Trident"],$="Windows");else if(L&&(F=(c=L.lang.System).getProperty("os.arch"),$=$||c.getProperty("os.name")+" "+c.getProperty("os.version")),w){try{N=n.require("ringo/engine").version.join("."),j="RingoJS"}catch(e){(c=n.system)&&c.global.system==n.system&&(j="Narwhal",$||($=c[0].os||null))}j||(j="Rhino")}else"object"==typeof n.process&&!n.process.browser&&(c=n.process)&&("object"==typeof c.versions&&("string"==typeof c.versions.electron?(P.push("Node "+c.versions.node),j="Electron",N=c.versions.electron):"string"==typeof c.versions.nw&&(P.push("Chromium "+N,"Node "+c.versions.node),j="NW.js",N=c.versions.nw)),j||(j="Node.js",F=c.arch,$=c.platform,N=(N=/[\d.]+/.exec(c.version))?N[0]:null));$=$&&v($)}if(N&&(c=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(N)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(B&&i.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(V=/b/i.test(c)?"beta":"alpha",N=N.replace(RegExp(c+"\\+?$"),"")+("beta"==V?k:O)+(/\d+\+?/.exec(c)||"")),"Fennec"==j||"Firefox"==j&&/\b(?:Android|Firefox OS)\b/.test($))j="Firefox Mobile";else if("Maxthon"==j&&N)N=N.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(D))"Xbox 360"==D&&($=null),"Xbox 360"==D&&/\bIEMobile\b/.test(t)&&P.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(j)&&(!j||D||/Browser|Mobi/.test(j))||"Windows CE"!=$&&!/Mobi/i.test(t))if("IE"==j&&B)try{null===n.external&&P.unshift("platform preview")}catch(e){P.unshift("embedded")}else(/\bBlackBerry\b/.test(D)||/\bBB10\b/.test(t))&&(c=(RegExp(D.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||N)?($=((c=[c,/BB10/.test(t)])[1]?(D=null,G="BlackBerry"):"Device Software")+" "+c[0],N=null):this!=u&&"Wii"!=D&&(B&&T||/Opera/.test(j)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==j&&/\bOS X (?:\d+\.){2,}/.test($)||"IE"==j&&($&&!/^Win/.test($)&&N>5.5||/\bWindows XP\b/.test($)&&N>8||8==N&&!/\bTrident\b/.test(t)))&&!d.test(c=e.call(u,t.replace(d,"")+";"))&&c.name&&(c="ing as "+c.name+((c=c.version)?" "+c:""),d.test(j)?(/\bIE\b/.test(c)&&"Mac OS"==$&&($=null),c="identify"+c):(c="mask"+c,j=A?v(A.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(c)&&($=null),B||(N=null)),W=["Presto"],P.push(c));else j+=" Mobile";(c=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(c=[parseFloat(c.replace(/\.(\d)$/,".0$1")),c],"Safari"==j&&"+"==c[1].slice(-1)?(j="WebKit Nightly",V="alpha",N=c[1].slice(0,-1)):N!=c[1]&&N!=(c[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(N=null),c[1]=(/\bChrome\/([\d.]+)/i.exec(t)||0)[1],537.36==c[0]&&537.36==c[2]&&parseFloat(c[1])>=28&&"WebKit"==W&&(W=["Blink"]),B&&(S||c[1])?(W&&(W[1]="like Chrome"),c=c[1]||((c=c[0])<530?1:c<532?2:c<532.05?3:c<533?4:c<534.03?5:c<534.07?6:c<534.1?7:c<534.13?8:c<534.16?9:c<534.24?10:c<534.3?11:c<535.01?12:c<535.02?"13+":c<535.07?15:c<535.11?16:c<535.19?17:c<536.05?18:c<536.1?19:c<537.01?20:c<537.11?"21+":c<537.13?23:c<537.18?24:c<537.24?25:c<537.36?26:"Blink"!=W?"27":"28")):(W&&(W[1]="like Safari"),c=(c=c[0])<400?1:c<500?2:c<526?3:c<533?4:c<534?"4+":c<535?5:c<537?6:c<538?7:c<601?8:"8"),W&&(W[1]+=" "+(c+="number"==typeof c?".x":/[.+]/.test(c)?"":"+")),"Safari"==j&&(!N||parseInt(N)>45)&&(N=c)),"Opera"==j&&(c=/\bzbov|zvav$/.exec($))?(j+=" ",P.unshift("desktop mode"),"zvav"==c?(j+="Mini",N=null):j+="Mobile",$=$.replace(RegExp(" *"+c+"$"),"")):"Safari"==j&&/\bChrome\b/.exec(W&&W[1])&&(P.unshift("desktop mode"),j="Chrome Mobile",N=null,/\bOS X\b/.test($)?(G="Apple",$="iOS 4.3+"):$=null),N&&0==N.indexOf(c=/[\d.]+$/.exec($))&&t.indexOf("/"+c+"-")>-1&&($=C($.replace(c,""))),W&&!/\b(?:Avant|Nook)\b/.test(j)&&(/Browser|Lunascape|Maxthon/.test(j)||"Safari"!=j&&/^iOS/.test($)&&/\bSafari\b/.test(W[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(j)&&W[1])&&(c=W[W.length-1])&&P.push(c),P.length&&(P=["("+P.join("; ")+")"]),G&&D&&D.indexOf(G)<0&&P.push("on "+G),D&&P.push((/^on /.test(P[P.length-1])?"":"on ")+D),$&&(c=/ ([\d.+]+)$/.exec($),s=c&&"/"==$.charAt($.length-c[0].length-1),$={architecture:32,family:c&&!s?$.replace(c[0],""):$,version:c?c[1]:null,toString:function(){var e=this.version;return this.family+(e&&!s?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(c=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(F))&&!/\bi686\b/i.test(F)?($&&($.architecture=64,$.family=$.family.replace(RegExp(" *"+c),"")),j&&(/\bWOW64\b/i.test(t)||B&&/\w(?:86|32)$/.test(i.cpuClass||i.platform)&&!/\bWin64; x64\b/i.test(t))&&P.unshift("32-bit")):$&&/^OS X/.test($.family)&&"Chrome"==j&&parseFloat(N)>=39&&($.architecture=64),t||(t=null);var J={};return J.description=t,J.layout=W&&W[0],J.manufacturer=G,J.name=j,J.prerelease=V,J.product=D,J.ua=t,J.version=j&&N,J.os=$||{architecture:null,family:null,version:null,toString:function(){return"null"}},J.parse=e,J.toString=function(){return this.description||""},J.version&&P.unshift(N),J.name&&P.unshift(j),$&&j&&($!=String($).split(" ")[0]||$!=j.split(" ")[0]&&!D)&&P.push(D?"("+$+")":"on "+$),P.length&&(J.description=P.join(" ")),J}();i&&r?u(S,function(e,t){i[t]=e}):a.platform=S}).call(t)}(n={exports:{}},n.exports),n.exports),a={rtc:{iceServers:[{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.l.google.com:19302"}],localStream:void 0,localVideo:void 0},signalingServer:{url:"wss://signal.remotemonster.com/ws"},appServer:{url:"https://signal.remotemonster.com/rest"},sdk:{logLevel:void 0,country:void 0},credential:{key:void 0,serviceId:void 0},view:{local:void 0,remote:void 0},media:{video:!0,audio:!0}};class i{constructor(){this.token,this.channel={name:void 0,peers:[],serviceId:void 0,startTime:void 0,status:void 0,type:void 0,id:void 0,msType:"Ms"},this.peers=[],this.localVideo,this.localStream,this.videoCodec,this.audioCodec,this.remoteVideo,this.remoteStream,this.devices,this.isCaller,this.startTime,this.endTime,this.serviceId,this.peerConnection,this.signalingConnection,this.state,this.hasAddTrack,this.eventManager,this.health,this.useVideo=!0,this.useAudio=!0,this.currentVideoDeviceId,this.useRecord=!1,this.remoteRecorder,this.localRecorder,this.mediaManager,this.hasLocalStream=!1,this.isConnectToSignal=!1,this.broadcast=!1,this.videoBandwith,this.audioBandwith}}const r=function(){const e="[RM]",t=["SILENT","ERROR","WARN","INFO","DEBUG","VERBOSE"];let n;var o;return Object.freeze({init:function(e){if(!t.includes(e.logLevel))throw new Error("Logger:UnmatchedLogLevel");o=e,n=e.logLevel},e:function(...t){if("SILENT"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.error(e+"E>",...t)},w:function(...t){if("SILENT"!==n&&"ERROR"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.warn(e+"W>",...t)},g:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.group(e+"G>",...t)},gEnd:function(){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return console.groupEnd()},l:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.info(e+"I>",...t)},i:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.info(e+"I>",...t)},d:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n&&"INFO"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.debug(e+"D>",...t)},v:function(...t){if("SILENT"!==n&&"ERROR"!==n&&"WARN"!==n&&"INFO"!==n&&"DEBUG"!==n)return o.eventManager.hasEventListener("onLog")&&o.eventManager.dispatchEvent("onLog",t),console.debug(e+"V>",...t)}})}(),c=function(){return Object.freeze({validateConfig:function(e,t){const n=Object.seal({credential:{key:void 0,serviceId:void 0}});Object.keys(n).forEach(e=>{Object.keys(n[e]).forEach(o=>{t[e][o]?n[e][o]=!0:n[e][o]=!1})}),Object.keys(n).forEach(t=>{Object.keys(n[t]).forEach(o=>{!1===n[t][o]&&e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","InvalidParameterError")})})},bind:function(e,t){if(!e||!t)throw new Error("Failed to execute 'bind' on 'utils': 2 arguments required, but only "+arguments.length+" present.");return function(){e.apply(t,Array.prototype.slice.call(arguments))}},buildMessage:function(e,t,n){var o="\r\n",a=[],i="";i+="Content-Disposition: form-data; ",i+='name=files"; ',i+='filename="'+e+'"'+o,i+="Content-Type: application/octet-stream",i+=o+o,i+=t+o,a.push(i);var r="--"+n+o;return r+=a.join("--"+n+o),r+="--"+n+"--"+o},setMediaBitrate:function(e,t,n){for(var o=e.split("\n"),a=-1,i=0;i<o.length;i++)if(0===o[i].indexOf("m="+t)){a=i;break}if(-1===a)return console.debug("Could not find the m line for",t),e;for(console.debug("Found the m line for",t,"at line",a),a++;0===o[a].indexOf("i=")||0===o[a].indexOf("c=");)a++;if(0===o[a].indexOf("b"))return console.debug("Replaced b line at line",a),o[a]="b=AS:"+n,o.join("\n");console.debug("Adding new b line before line",a);var r=o.slice(0,a);return r.push("b=AS:"+n),(r=r.concat(o.slice(a,o.length))).join("\n")},getVideoFractionLostRating:function(e){return e<40?1:e<55?2:e<70?3:e<90?4:5},getAudioFractionLostRating:function(e){return e<50?1:e<150?2:e<250?3:e<350?4:5}})}();class s{constructor(e,t,n){this.context=e,this.isStart=!1,this.stream=t,this.type="Firefox"===o.name?"audio/ogg":"audio/webm",this.recorder=new MediaRecorder(this.stream,{audioBitsPerSecond:8192,videoBitsPerSecond:16e3,mimeType:this.type}),this.array=[],this.recorder.ondataavailable=(e=>{this.array.push(e.data)}),this.recorder.onstop=(e=>{var t=new Blob(this.array,{type:this.type}),o=new XMLHttpRequest;o.open("POST",this.context.recordUrl,!0),o.setRequestHeader("X-FILENAME",this.context.serviceId+"."+this.context.channel.id+n+".ogg"),o.onload=function(e){r.d("upload is completed")},o.send(t)})}start(){this.isStart=!0,this.recorder.start(3e3)}stop(){this.isStart&&this.recorder.stop()}}class d{constructor(e){this.context=e}bindLocalStreamToPeerConnection(e){0==this.context.useVideo&&0==this.context.useAudio||(this.context.hasAddTrack?(a.rtc.localStream.getTracks().forEach(t=>e.addTrack(t,a.rtc.localStream)),r.d("Local stream added:",e.getSenders())):(e.addStream(a.rtc.localStream),r.i("Local stream added:",e.getLocalStreams())),this.context.eventManager.hasEventListener("onAddLocalStream")&&this.context.eventManager.dispatchEvent("onAddLocalStream",a.rtc.localStream))}gotDevicesInfo(e){this.context.devices=e}isLocalPrepared(){return 0==a.media.audio&&0==a.media.video||(!a.rtc.localVideo||!!a.rtc.localVideo.srcObject)}async createLocalStream(e,t){var n,o;if((0!=t.audio||0!=t.video)&&e){if(a.view.localStream)return a.rtc.localStream=a.view.localStream,void(e.hasLocalStream=!0);try{try{o=await navigator.mediaDevices.getUserMedia(t)}catch(e){console.log(e)}if(null!==a.rtc.localVideo&&void 0!==a.rtc.localVideo){r.d("type of localvideo: "+typeof a.rtc.localVideo),r.d("localvideo: "+a.rtc.localVideo),r.d("stream: "+o);try{a.rtc.localVideo.srcObject=o}catch(e){console.log(e)}}a.rtc.localStream=o,e.eventManager.dispatchEvent("onDisplayUserMedia",a.rtc.localStream),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","LOCALMEDIA"),e.hasLocalStream=!0,e.isConnectToSignal&&e.eventManager.hasEventListener("onInit")&&e.eventManager.dispatchEvent("onInit",e.token),r.i("config stream"+a.rtc.localStream),e.useRecord&&(e.localRecorder=new s(e,o,"LL"));try{n=await navigator.mediaDevices.enumerateDevices()}catch(e){console.log(e)}e.devices=n,e.currentVideoDeviceId=n[0].deviceId}catch(t){e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","UserMediaDeviceFailedError"),r.e(error)}}}bindRemoteStreamToView(e){let t;r.g("Media: Bind remote stream: Bind remote media to video element and regist to context"),r.d("event:",e),t=this.context.hasAddTrack?e.streams[0]:e.stream,r.d("Stream:",t),this.context.remoteVideo.srcObject=t,this.context.remoteStream=t,r.gEnd()}mediaStreamTrackSwitch(e){let t;return Object.freeze({type:function(e){if("Video"!==e&&"Audio"!==e)throw new Error("MediaStreamSwitcher:InvailedMediaType");return t=`get${e}Tracks`,this},enabled:function(n){switch(n){case!0:e[t]().forEach(e=>{e.enabled=!0});break;case!1:e[t]().forEach(e=>{e.enabled=!1});break;default:throw new Error("MediaStreamSwitcher:InvalidCommand")}}})}setAudioOutput(e){a.rtc.localVideo||a.rtc.localVideo.setSinkId(e).then(()=>{r.d("Devices: Audio output device attached success:",e)}).catch(()=>{r.e("Devices: Audio output device attached failed:",e)})}setUserDevices({audioSource:e,videoSource:t}){window.stream&&window.stream.getTracks().forEach(function(e){e.stop()}),createLocalStream({audio:{deviceId:e?{exact:e}:void 0},video:{deviceId:t?{exact:t}:void 0}})}}const l=Object.freeze(["INIT","WAIT","CONNECT","COMPLETE","CLOSE","EXIT","FAIL"]);class h{constructor(e){this.interval=5e3,this.statsReportTimer=null,this.context=e,this.oldStats=null,this.result=null,this.fractionLost={audio:[{rating:1,fromFractionLost:0,toFractionLost:50},{rating:2,fromFractionLost:51,toFractionLost:150},{rating:3,fromFractionLost:151,toFractionLost:250},{rating:4,fromFractionLost:251,toFractionLost:350},{rating:5,fromFractionLost:351,toFractionLost:9999999}],video:[{rating:1,fromFractionLost:0,toFractionLost:40},{rating:2,fromFractionLost:41,toFractionLost:55},{rating:3,fromFractionLost:56,toFractionLost:70},{rating:4,fromFractionLost:71,toFractionLost:90},{rating:5,fromFractionLost:91,toFractionLost:9999999}]}}stop(){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null)}start(){!0!==this.context.isCaller&&(r.i("Health is start w/interval:"+this.interval),this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null),this.statsReportTimer=window.setInterval(c.bind(function(){this.getStats(c.bind(function(e){var t,n,a,i=0,r=0,s=null,d={localCandidate:"",remoteCandidate:"",localFrameWidth:0,localFrameHeight:0,remoteFrameWidth:0,remoteFrameHeight:0,localFrameRate:0,remoteFrameRate:0,availableSendBandwidth:0,availableReceiveBandwidth:0,rtt:0,rttRating:"",rating:0,localAudioFractionLost:0,localVideoFractionLost:0,localAudioFractionRating:0,localVideoFractionRating:0,remoteAudioFractionLost:0,remoteVideoFractionLost:0,remoteAudioFractionRating:0,remoteVideoFractionRating:0,fractionRating:0,localAudioPacketsLost:0,remoteAudioPaketsLost:0,localVideoPacketsLost:0,remoteVideoPacketsLost:0},l=0,h=0,g=0,p=0,v=0,u=0,m=0,f=0,b=0,C=0,S=0,E=0,y=0,M=0,x=0,R=0,L=this.oldStats;if("Firefox"===o.name){for(s in e)"candidatepair"!==e[s].type||!0!==e[s].selected?"inboundrtp"!==e[s].type||"audio"!==e[s].mediaType||!0!==e[s].isRemote?"inboundrtp"!==e[s].type||"video"!==e[s].mediaType||!0!==e[s].isRemote||(e[s].hasOwnProperty("mozRtt")&&(n=e[s].mozRtt),e[s].hasOwnProperty("packetsLost")&&(C=e[s].packetsLost),e[s].hasOwnProperty("packetsReceived")&&(E=e[s].packetsReceived)):(e[s].hasOwnProperty("mozRtt")&&(t=e[s].mozRtt),e[s].hasOwnProperty("packetsLost")&&(b=e[s].packetsLost),e[s].hasOwnProperty("packetsReceived")&&(S=e[s].packetsReceived)):(d.localCandidate=e[e[s].localCandidateId].candidateType,d.remoteCandidate=e[e[s].remoteCandidateId].candidateType);for(s in L)"inboundrtp"!==e[s].type||"audio"!==e[s].mediaType||!0!==e[s].isRemote?"inboundrtp"!==e[s].type||"video"!==e[s].mediaType||!0!==e[s].isRemote||(e[s].hasOwnProperty("packetsLost")&&(M=e[s].packetsLost),e[s].hasOwnProperty("packetsReceived")&&(R=e[s].packetsReceived)):(e[s].hasOwnProperty("packetsLost")&&(y=e[s].packetsLost),e[s].hasOwnProperty("packetsReceived")&&(x=e[s].packetsReceived));!1===this.context.useVideo?d.rtt=t:d.rtt=n}else{if("Chrome"!==o.name)return;for(r=e.length;i<r;i++)"true"!==e[i].googActiveConnection?e[i].hasOwnProperty("audioInputLevel")?(l=parseInt(e[i].packetsLost),g=parseInt(e[i].packetsSent),!1===this.context.useVideo&&(d.rtt=parseInt(e[i].googRtt))):e[i].hasOwnProperty("googFrameWidthSent")?(d.localFrameWidth=parseInt(e[i].googFrameWidthSent),d.localFrameHeight=parseInt(e[i].googFrameHeightSent),d.localFrameRate=parseInt(e[i].googFrameRateSent),h=parseInt(e[i].packetsLost),p=parseInt(e[i].packetsSent),!0===this.context.useVideo&&(d.rtt=parseInt(e[i].googRtt))):e[i].hasOwnProperty("audioOutputLevel")?(b=parseInt(e[i].packetsLost),S=parseInt(e[i].packetsReceived)):e[i].hasOwnProperty("googFrameWidthReceived")?(d.remoteFrameWidth=parseInt(e[i].googFrameWidthReceived),d.remoteFrameHeight=parseInt(e[i].googFrameHeightReceived),d.remoteFrameRate=parseInt(e[i].googFrameRateReceived),C=parseInt(e[i].packetsLost),E=parseInt(e[i].packetsReceived)):e[i].hasOwnProperty("googAvailableSendBandwidth")&&(d.availableSendBandwidth=parseInt(e[i].googAvailableSendBandwidth),d.availableReceiveBandwidth=parseInt(e[i].googAvailableReceiveBandwidth)):(d.localCandidate=e[i].googLocalCandidateType,d.remoteCandidate=e[i].googRemoteCandidateType);for(i=0;i<L.length;i++)L[i].hasOwnProperty("audioInputLevel")?(v=parseInt(L[i].packetsLost),m=parseInt(L[i].packetsSent)):L[i].hasOwnProperty("googFrameWidthSent")?(u=parseInt(L[i].packetsLost),f=parseInt(L[i].packetsSent)):L[i].hasOwnProperty("audioOutputLevel")?(y=parseInt(L[i].packetsLost),x=parseInt(L[i].packetsReceived)):L[i].hasOwnProperty("googFrameWidthReceived")&&(M=parseInt(L[i].packetsLost),R=parseInt(L[i].packetsReceived))}var w=parseInt((l-v)/(g-m)*255||0),O=parseInt((h-u)/(p-f)*255||0);d.localAudioPacketsLost=parseInt((l-v)/this.interval),d.localVideoPacketsLost=parseInt((h-u)/this.interval),d.remoteAudioPacketsLost=parseInt((b-y)/this.interval),d.remoteVideoPacketsLost=parseInt((C-M)/this.interval),d.localAudioFractionLost=w,d.localVideoFractionLost=O,d.localAudioFractionRating=c.getAudioFractionLostRating(w,this.fractionLost.audio),d.localVideoFractionRating=c.getVideoFractionLostRating(O,this.fractionLost.video);var k=parseInt((b-y)/(S-x)*255||0),I=parseInt((C-M)/(E-R)*255||0);d.remoteAudioFractionLost=k,d.remoteVideoFractionLost=I,d.remoteAudioFractionRating=c.getAudioFractionLostRating(k,this.fractionLost.audio),d.remoteVideoFractionRating=c.getVideoFractionLostRating(I,this.fractionLost.video),d.fractionRating=d.remoteVideoFractionRating,d.rttRating=this.getRttRating(d.rtt),d.rating=this.getMaxRating(d.rttRating,d.remoteAudioFractionRating,d.remoteVideoFractionRating,d.localAudioFractionRating,d.localVideoFractionRating),this.oldStats=e,this.result=d,this.context.eventManager.hasEventListener("onStat")&&this.context.eventManager.dispatchEvent("onStat",d),(a=this.context.signalingConnection.createMessage({command:"health",body:JSON.stringify(d)}))&&(this.context.database||this.context.signalingConnection.send(JSON.stringify(a)))},this))},this),this.interval))}getMaxRating(){var e=0,t=0;for(e=0;e<arguments.length;e++)arguments[e]>t&&(t=arguments[e]);return t}getRttRating(e){var t=0;return e>=1e3?t=5:e>=800?t=4:e>=600?t=3:e>=400?t=2:e<400&&(t=1),t}getVideoFractionLostRating(e){return e<40?1:e<55?2:e<70?3:e<90?4:5}getAudioFractionLostRating(e){return e<50?1:e<150?2:e<250?3:e<350?4:5}getFractionLostRating(e,t){var n=t;for(let t=0;t<n.length;t++)if(n[t].fromFractionLost<=e&&n[t].toFractionLost>=e)return n[t].rating;return 1}getStats(e){"Firefox"===o.name?this.context.peerConnection.getStats(null,c.bind(function(t){e.call(this,t)},this),function(){}):this.context.peerConnection.getStats(c.bind(function(t){var n=[];t.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),e.call(this,n)},this))}}t===t.window&&t.URL&&t.Blob&&t.Worker;function g({context:e,media:t}){const n={onCreate(t){if(r.i("Signaling: On create channel"),e.isCaller=!1,e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","WAIT"),!t.channel&&e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"Can not make a channel"})}e.channel=t.channel,r.i("Channel id:",e.channel.id),r.i("Channel type: ",e.channel.type),e.eventManager.hasEventListener("onCreateChannel")&&e.eventManager.dispatchEvent("onCreateChannel",e.channel.id),e.eventManager.hasEventListener("onConnect")&&"P2P"===e.channel.type&&e.eventManager.dispatchEvent("onConnect",e.channel.id),e.eventManager.hasEventListener("onCreate")&&"BROADCAST"===e.channel.type?e.eventManager.dispatchEvent("onCreate",e.channel.id):e.eventManager.hasEventListener("onJoin")&&"VIEWER"===e.channel.type&&e.eventManager.dispatchEvent("onJoin",e.channel.id),"BROADCAST"===e.channel.type?function(){const t={offerToReceiveAudio:!1,offerToReceiveVideo:!1};"Ms"===e.channel.msType?e.peerConnection.createOffer(t).then(a).catch(t=>{if(r.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;}):e.peerConnection.createOffer(t).then(i).catch(t=>{if(r.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})}():"VIEWER"===e.channel.type&&function(){r.i("createViewerOffer is called "+o.name);"Safari"!==o.name&&"safari"!==o.name||(r.d("safari mode is on"),e.peerConnection.addTransceiver("video").setDirection("recvonly"));e.peerConnection.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(a).catch(t=>{if(r.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})}(),r.gEnd()},onConnect(t){if(r.i("Signaling: On connect channel"),e.isCaller=!0,e.channel=t.channel,r.i("Channel id:",e.channel.id),r.i("Channel type: ",e.channel.type),r.d("isCaller: true"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","CONNECT"),!t.channel){if(e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"Can not make a channel"})}return}e.eventManager.hasEventListener("onConnectChannel")&&e.eventManager.dispatchEvent("onConnectChannel",e.channel.id);e.peerConnection.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(i).catch(t=>{if(r.e("PeerConnection: Create offer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create offer failed"})}else;})},onSdp(t){r.i("Signaling: On sdp");const n=new RTCSessionDescription(JSON.parse(t.body));r.i("-> Remote Description:",n),e.videoBandwidth&&(n.sdp=c.setMediaBitrate(n.sdp,"video",e.videoBandwidth)),e.peerConnection.setRemoteDescription(n).then(()=>{r.i("Remote Description Setted")}).catch(t=>{if(r.e("PeerConnection: Remote description set failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Remote description set failed"})}else;}),r.i("Am I a caller?:",e.isCaller),r.d("channel info?:",e.channel),e.isCaller||"offer"!==n.type||(r.i("Create answer"),e.peerConnection.createAnswer().then(i).catch(t=>{if(r.e("PeerConnection: Create Answer failed:",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"PeerConnection: Create Answer failed"})}else;})),r.gEnd()},onDisconnectChannel(t){r.i("Signaling: onDisconnectChannel"),(t===e.token||"BROADCAST"===e.channel.type&&"room"===t)&&s(),e.eventManager.hasEventListener("onDisconnectChannel")&&e.eventManager.dispatchEvent("onDisconnectChannel",t.body),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose",t.body)},ping(t){t.command="pong",e.signalingConnection.send(JSON.stringify(t))},onStateChange(t){if(l.includes(t.body))switch(e.state=t.body,e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange",t.body),t.body){case"INIT":r.i(">STATE:INIT");break;case"WAIT":r.i(">STATE:WAIT");break;case"CONNECT":r.i(">STATE:CONNECT");break;case"COMPLETE":r.i(">STATE:COMPLETE"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","COMPLETE"),e.eventManager.hasEventListener("onComplete")&&e.eventManager.dispatchEvent("onComplete");break;case"CLOSE":r.i(">STATE:CLOSE"),s(),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","CLOSE"),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose");break;case"FAIL":r.i(">STATE:FAIL"),s(),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError")}else r(r.e("Unknown signaling state:"+t.body));r.gEnd()},onIce(t){const n=new RTCIceCandidate(JSON.parse(t.body));r.d("Candidate:",JSON.stringify(n)),e.peerConnection.addIceCandidate(n).then(()=>{r.d("Add ICE candidate success")}).catch(t=>{if(r.e("Peer Connection: Add ICE candidate failed",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ICEFailedError",body:"Peer Connection: Add ICE candidate failed"})}}),r.gEnd()},onMessage(t){r.d("Signaling: On message: "+t.body),e.eventManager.hasEventListener("onMessage")&&e.eventManager.dispatchEvent("onMessage",t.body)},onSearch(t){r.d("Signaling: On search: "+t.body),e.eventManager.hasEventListener("onSearch")&&e.eventManager.dispatchEvent("onSearch",t.body)},onError(t){r.e("Signaling error -> Message:",t),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError",t)}};function a(t){r.i("Local Description:",t),e.videoCodec?(r.v("Signaling: video codec: "+e.videoCodec),t.sdp=d(t.sdp,/m=video(:?.*)?/,e.videoCodec)):(r.v("Signaling: video codec: H264"),t.sdp=d(t.sdp,/m=video(:?.*)?/,"H264"));const n=e.signalingConnection.createMessage({command:"sdp",body:JSON.stringify(t)});n.channel.type=e.channel.type,e.signalingConnection.send(JSON.stringify(n))}function i(t){r.i("new Local Description:",t),e.videoCodec?(r.v("Signaling: video codec: "+e.videoCodec),t.sdp=d(t.sdp,/m=video(:?.*)?/,e.videoCodec)):(r.v("Signaling: video codec: H264"),t.sdp=d(t.sdp,/m=video(:?.*)?/,"H264")),e.videoBandwidth&&(t.sdp=c.setMediaBitrate(t.sdp,"video",e.videoBandwidth));const n=e.signalingConnection.createMessage({command:"sdp",body:JSON.stringify(t)});n.channel.type=e.channel.type,e.peerConnection.setLocalDescription(t).then(()=>{r.v("Local Description Setted:",e.peerConnection.localDescription),r.i("Message ->:",n),e.signalingConnection.send(JSON.stringify(n))}).catch(t=>{if(r.e("PeerConnection: set Local description failed",t),e.eventManager.hasEventListener("onError")){e.eventManager.dispatchEvent("onError",{code:"ConnectChannelFailedError",body:"PeerConnection: set Local description failed"})}})}function s(){r.i("close resources"),e.health.stop(),e.peerConnection.close(),e.signalingConnection.close(),e.state="CLOSE",e.useRecord&&e.remoteRecorder&&(e.remoteRecorder.stop(),e.remoteRecorder=null),e.useRecord&&e.localRecorder&&(e.localRecorder.stop(),e.localRecorder=null,e.useRecord=!1),e.remoteVideo.srcObject&&e.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),e.remoteVideo&&(e.remoteVideo.srcObject=null),e.signalingConnection&&e.peerConnection&&(e.health&&e.health.stop(),e.hasAddTrack?e.peerConnection.ontrack=null:e.peerConnection.onaddstream=null,e.peerConnection.onremovestream=null,e.peerConnection.onicecandidate=null,e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.onsignalingstatechange=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onnegotiationneeded=null)}function d(e,t,n){var o,a,i,r=[],c=new RegExp("a=rtpmap:(\\d+) "+n+"/\\d+");if(!(o=e.match(t)))return e;if(!(a=e.match(c)))return e;o=o[0],a=a[1],i=o.split(" "),r.push(i[0]),r.push(i[1]),r.push(i[2]),r.push(a);for(var s=3;s<i.length;s++)i[s]!==a&&r.push(i[s]);return e.replace(o,r.join(" "))}e.signalingConnection.onMessage(function(e){r.d("Signaling: Got command from server");const t=JSON.parse(e.data),o=t.command;r.v(`-> Message: ${t.command}:`,t),n[o](t)})}return class{constructor({config:e,listener:t}){this.version="2.0.10",this.context=new i,this.context.eventManager=function(){const e=["onInit","onConnectChannel","onCreateChannel","onComplete","onConnect","onDisplayUserMedia","onAddLocalStream","onAddRemoteStream","onStateChange","onDisconnectChannel","onMessage","onError","onStat","onSearch","onClose","onLog","onJoin","onCreate"],t=new Map(e.map(e=>[e]));return Object.freeze({addEventListener:function({type:n,listenerItem:o}){if("function"!=typeof o)throw new Error("EventManager:listenerMustBeAFunction");if(!e.includes(n))throw new Error("EventManager:UnmatchedEvent");t.set(n,o)},hasEventListener:function(n){if(e.includes(n))return void 0!==t.get(n);throw new Error("EventManager:UnmatchedEvent")},removeEventListener:function(n){if(!e.includes(n)||!t.has(n))throw new Error("EventManager:UnmatchedEventOrDidNotContainAnylistener");t.set(n,void 0)},getEventListeners:function(){return t},dispatchEvent:function(n,...o){if(e.includes(n))return void 0===t.get(n)?void 0:t.get(n)(...o);throw new Error("EventManager:UnmatchedEvent")}})}(),this.config=e,c.validateConfig(this.context,this.config),this.media=new d(this.context),this.context.mediaManager=this.media,this.uri=a.appServer.url,this.key=this.config.credential.key,this.serviceId=this.config.credential.serviceId,this.context.key=this.key,this.context.serviceId=this.serviceId,this.context.state="INIT",this.context.logLevel=this.config.dev&&this.config.dev.logLevel?this.config.dev.logLevel:"INFO",r.init(this.context),t&&Object.keys(t).forEach(e=>{const n=t[e];this.context.eventManager.addEventListener({type:e,listenerItem:n})}),this.config.media||(this.config.media={audio:!0,video:!0,record:!1}),this.config.media.record&&(this.context.useRecord=this.config.media.record,this.config.media.recordUrl?this.context.recordUrl=this.config.media.recordUrl:this.context.recordUrl="https://demo.remotemonster.com/rest/record"),a.media=this.config.media,a.view=this.config.view,this.config.media.video.codec&&(this.context.videoCodec=this.config.media.video.codec),this.config.media.audio.codec&&(this.context.audioCodec=this.config.media.audio.codec),!1===this.config.media.video&&(this.context.useVideo=!1),!1===this.config.media.audio&&(this.context.useAudio=!1),this.config.media.video.maxBandwidth&&(this.context.videoBandwidth=this.config.media.video.maxBandwidth),this.config.media.audio.maxBandwidth&&(this.context.audioBandwidth=this.config.media.audio.maxBandwidth),this.config.credential.resturl&&(this.config.credential.resturl=this.config.credential.resturl.replace("/init",""),a.appServer.url=this.config.credential.resturl,this.uri=a.appServer.url),this.config.credential.wsurl&&(a.signalingServer.url=this.config.credential.wsurl)}async init(){r.d("init is called");var e=this.context,t=this.config,n={credential:{key:this.key,serviceId:this.serviceId},env:{os:o.os.family,osVersion:o.os.version||"0",device:o.name,deviceVersion:o.version||"0",networkType:Navigator.connection,sdkVersion:this.version}};this.config.sdk&&this.config.sdk.country&&(n.env.country=this.config.sdk.country),!0===this.config.media.sendonly&&(n.sendonly="true"),!0===this.config.media.recvonly&&(n.recvonly="true"),this.config.media.roomid&&(n.id=this.config.media.roomid);var i={method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(n)};try{var d=await fetch(this.uri+"/init",i),l=await d.json()}catch(t){e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","WebSocketFailedError"),r.e("Init: failed:",error)}r.d("-> Message:",l),Object.keys(l).forEach(t=>{switch(t){case"iceServers":a.rtc.iceServers=l[t];break;case"token":e.token=l[t];break;case"key":e.channel.id=l[t];break;case"name":e.channel.name=l[t]}}),1!=t.media.sendonly&&1!=t.media.recvonly&&1!=t.media.broadcast||(e.broadcast=!0),e.signalingConnection=await async function({url:e,context:t}){const n=await function(){r.d("Signaling: Connect");const t=new WebSocket(e);return r.d("Signaling Connection: ",t),t}();var o=!1;function i(...e){return n.send(...e)}function c({command:e,body:n}){r.d("Signaling: Create Message %j",n);const o={command:e,token:t.token,serviceId:t.serviceId,channel:{id:t.channel.id,name:t.channel.name,type:t.channel.type}};return n&&(o.body=n),r.v("createMessage: "+JSON.stringify(o)),o}return n.onopen=async function(e){r.i("Signaling: Success connect to the signaling server"),r.v("OpenEvent:",e),o=!0,t.isConnectToSignal=!0,t.eventManager.hasEventListener("onInit")&&t.eventManager.dispatchEvent("onInit",t.token),t.eventManager.hasEventListener("onStateChange")&&t.eventManager.dispatchEvent("onStateChange","INIT"),!0!==a.media.recvonly&&(r.d("try to create local stream"),await t.mediaManager.createLocalStream(t,a.media),t.mediaManager.bindLocalStreamToPeerConnection(t.peerConnection),r.d("success to create and bind local stream to pc"))},n.onclose=function(e){r.i("Signaling: Closed the signaling connection"),r.v("Event:",e),o=!1},n.onerror=function(e){r.i("Signaling: Error from the signaling connection."),r.v("Event",e),t.eventManager.hasEventListener("onError")&&t.eventManager.dispatchEvent("onError","WebSocketFailedError"),o=!1},Object.freeze({connectChannel:function(e){r.i("Signaling: Connect channel: As a caller"),t.startTime=(new Date).getTime(),t.isCaller=!0,t.channel.id=e;const n=c({command:"connect"});r.v("ConnectCh Message ->:",n),i(JSON.stringify(n))},createMessage:c,createViewerChannel:function(e){r.i("Signaling: Create channel: As a viewer"),t.startTime=(new Date).getTime(),t.isCaller=!1,t.channel.id=e;const n=c({command:"create"});n.channel.type="VIEWER",n.channel.id=e,r.v("ConnectCh Message ->:",n),i(JSON.stringify(n))},createBroadcastChannel:function(e){r.i("Signaling: Create channel: As a presenter"),t.startTime=(new Date).getTime(),t.isCaller=!1,t.channel.name=e;const n=c({command:"create"});n.channel.type="BROADCAST",r.v("ConnectCh Message ->:",n),r.i("channel id: "+t.channel.id),i(JSON.stringify(n))},send:i,close:function(){if(n.readyState<2){const e=c({command:"disconnect"});r.v("disconnect Message ->:",e),i(JSON.stringify(e)),n.close(),o=!1}},onMessage:function(e){n.onmessage=e},context:t,setDisconnectHandler:function(){t.channel.type},isOpened:function(){return o}})}({url:a.signalingServer.url,context:e}),1!=t.media.sendonly&&1!=t.media.recvonly&&1!=t.media.broadcast||(1==t.media.sendonly&&(e.channel.type="BROADCAST"),1==t.media.recvonly&&(e.channel.type="VIEWER"),e.signalingConnection.setDisconnectHandler()),e.peerConnection=new RTCPeerConnection(a.rtc,t.opt),e.hasAddTrack=void 0!==e.peerConnection.addTrack,g({context:e,media:this.media}),function({context:e,media:t}){function n(){e.health.stop(),e.peerConnection.close(),e.signalingConnection.close(),e.state="CLOSE",e.useRecord&&e.remoteRecorder&&(e.remoteRecorder.stop(),e.remoteRecorder=null),e.useRecord&&e.localRecorder&&(e.localRecorder.stop(),e.localRecorder=null,e.useRecord=!1),e.remoteVideo.srcObject&&e.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),e.remoteVideo&&(e.remoteVideo.srcObject=null),e.signalingConnection&&e.peerConnection&&(e.health&&e.health.stop(),e.hasAddTrack?e.peerConnection.ontrack=null:e.peerConnection.onaddstream=null,e.peerConnection.onremovestream=null,e.peerConnection.onicecandidate=null,e.peerConnection.oniceconnectionstatechange=null,e.peerConnection.onsignalingstatechange=null,e.peerConnection.onicegatheringstatechange=null,e.peerConnection.onnegotiationneeded=null)}function a(t){let n;r.g("PeerCon: Bind remote stream"),r.v("bindRemoteStream:",t),e.hasAddTrack?(r.v("PeerCon: context has track"),n=t.streams[0]):(r.v("PeerCon: context has stream"),n=t.stream),e.remoteVideo.srcObject=n,e.remoteStream=n,"Safari"!==o.name&&"safari"!==o.name||e.remoteVideo.paused&&e.remoteVideo.play(),e.useRecord&&!e.remoteRecorder&&(e.remoteRecorder=new s(e,n,"RR"),e.remoteRecorder.start(),e.localRecorder.start()),r.gEnd()}e.peerConnection.onicecandidate=function(t){r.i("PeerCon: HandleICECandidateEvent"),r.d("Event:",t),r.d("-> Candidate:",t.candidate);const n=e.signalingConnection.createMessage({command:"ice",body:JSON.stringify(t.candidate)});t.candidate&&(r.i("Message ->: ",n),"BROADCAST"===e.channel.type&&(n.channel.type="BROADCAST"),void 0===n||e.database||e.signalingConnection.send(JSON.stringify(n)))},e.peerConnection.onicegatheringstatechange=function(){r.i("PeerCon: Handle ice gathering state event"),r.d(`Event: ${e.peerConnection.iceGatheringState}:`,event)},e.peerConnection.onsignalingstatechange=function(t){switch(r.i("PeerCon: Handle signaling state change event"),r.d(`Event: ${e.peerConnection.signalingState}:`,t),e.peerConnection.signalingState){case"stable":e.endTime=(new Date).getTime(),e.eventManager.hasEventListener("onAddRemoteStream")&&e.eventManager.dispatchEvent("onAddRemoteStream",e.remoteStream);break;case"have-local-offer":case"have-remote-offer":case"have-local-pranswer":case"have-remote-pranswer":case"closed":break;default:r.e("Unknown signaling state event:",e.peerConnection.signalingState)}},e.peerConnection.onnegotiationneeded=function(e){r.d("PeerCon: Handle negotiation needed event"),r.d("Event:",e)},e.peerConnection.oniceconnectionstatechange=function(t){let o;switch(r.i("PeerCon: Handle ICE state change event"),r.i(`Event: ${e.peerConnection.iceConnectionState}:`,t),e.peerConnection.iceConnectionState){case"connected":r.i("ice State:connected"),e.eventManager.hasEventListener("onStateChange")&&e.eventManager.dispatchEvent("onStateChange","COMPLETE"),e.eventManager.hasEventListener("onComplete")&&e.eventManager.dispatchEvent("onComplete"),o=e.signalingConnection.createMessage({command:"stateChange",body:"COMPLETE"});var a=new h(e);if(a.getStats(c.bind(function(e){this.oldStats=e},a)),a.start(),e.health=a,"BROADCAST"===e.channel.type||"VIEWER"===e.channel.type)return;break;case"failed":r.i("ice State:failed"),e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","ICEFailedError"),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose","ICEFailedError"),r.e("Ice connection state change failed"),"CLOSE"!==e.state&&n();break;case"closed":return void r.i("ice State:closed");case"disconnected":return r.i("ice State:disconnected"),o=e.signalingConnection.createMessage({command:"stateChange",body:"CLOSE"}),e.eventManager.hasEventListener("onClose")&&e.eventManager.dispatchEvent("onClose","ICEFailedError"),r.e("Ice connection state change failed"),void("CLOSE"!==e.state&&n());case"completed":r.v("iceconState:completed");break;case"checking":r.v("iceconState:checking");break;default:r.e("Unknown ice connection change event:",e.peerConnection.iceConnectionState)}r.v("Message ->:",o),r.i("Sending ice state to other"),void 0!==o&&e.signalingConnection.send(JSON.stringify(o))},e.hasAddTrack?(r.i("PeerCon: context has addTrack"),e.peerConnection.ontrack=a):(r.i("PeerCon: context has onAddstream"),e.peerConnection.onaddstream=a),e.peerConnection.onremovestream=function(e){r.v("PeerCon: Handle remove stream event")}}({context:e,media:this.media}),e.useVideo&&t.view&&void 0!==t.view.local&&(a.rtc.localVideo=document.querySelector(`${t.view.local}`)),t.view&&void 0!==t.view.remote&&(e.remoteVideo=document.querySelector(`${t.view.remote}`)),t.media.recvonly&&(e.remoteVideo=document.querySelector(`${t.view.remote}`));for(let t=5;t<=11;t++){if(e.signalingConnection.isOpened()&&e.mediaManager.isLocalPrepared())return;{const e=Math.pow(2,t);r.v("wating for init %i",t),await this.wait(e)}}e.eventManager.hasEventListener("onError")&&e.eventManager.dispatchEvent("onError","WebSocketFailedError")}async connectCall(...e){r.d("connect is called"),await this.connectChannel(...e)}async connectChannel(...e){return r.d("createChannel is called"),await this.init(),this.context.signalingConnection.connectChannel(...e)}async createCast(e){r.d("createCast is called"),await this.init(),this.context.signalingConnection.createBroadcastChannel(e)}async joinCast(e){r.d("joinCast is called"),await this.init(),this.context.signalingConnection.createViewerChannel(e)}getHealth(){return this.context.health.result}getVersion(){return this.version}getChannelId(){return this.context.channel.id}pauseLocalVideo(e){r.d("pauseLocalVideo is called"),this.media.mediaStreamTrackSwitch(a.rtc.localStream).type("Video").enabled(!!e)}pauseRemoteVideo(e){r.d("pauseRemoteVideo is called"),this.media.mediaStreamTrackSwitch(this.context.remoteStream).type("Video").enabled(!!e)}cameraSwitch(){r.d("cameraSwitch is called"),this.media.setUserDevices(null,this.context.devices[1].deviceId)}muteLocalAudio(e){this.media.mediaStreamTrackSwitch(a.rtc.localStream).type("Audio").enabled(!!e)}muteRemoteAudio(e){this.media.mediaStreamTrackSwitch(this.context.remoteStream).type("Audio").enabled(!!e)}async fetchCalls(e){return await this.search(e)}search(e){r.d("search by"+e);const t={method:"GET",headers:{"Content-Type":"application/json"}};return new Promise((e,n)=>{fetch(this.uri+"/call/"+this.config.credential.serviceId,t).then(t=>{t.json().then(t=>{this.context.eventManager.hasEventListener("onSearch")&&this.context.eventManager.dispatchEvent("onSearch",t),e(t)}).catch(e=>{n(e)})})})}async fetchCasts(){return await this.liveRooms()}liveRooms(){const e={method:"GET",headers:{"Content-Type":"application/json"}};return new Promise((t,n)=>{fetch(this.uri+"/room/"+this.config.credential.serviceId,e).then(e=>{e.json().then(e=>{t(e)}).catch(e=>{n(e)})})})}sendMessage(e){r.g("Signaling: Send user message");const t=this.context.signalingConnection.createMessage({command:"message",body:e});r.d("Message ->:",t),this.context.signalingConnection.send(JSON.stringify(t)),r.gEnd()}close(){r.i("Remon.close"),this.context.useRecord&&this.context.remoteRecorder&&(this.context.remoteRecorder.stop(),this.context.remoteRecorder=null),this.context.useRecord&&this.context.localRecorder&&(this.context.localRecorder.stop(),this.context.localRecorder=null,this.context.useRecord=!1),this.context.remoteVideo&&this.context.remoteVideo.srcObject&&(this.context.remoteVideo.srcObject.getTracks().forEach(e=>e.stop()),this.context.remoteVideo.srcObject=null),a.rtc.localVideo&&a.rtc.localVideo.srcObject&&a.rtc.localVideo.srcObject.getTracks().forEach(e=>e.stop()),this.context.database&&(this.context.database.ref("/msg/peer/"+this.context.token).onDisconnect().remove(),this.context.database.ref("/tokens/"+this.context.serviceId+"/"+this.context.token).onDisconnect().remove()),this.context.signalingConnection&&this.context.peerConnection&&(this.context.health&&this.context.health.stop(),this.context.hasAddTrack?this.context.peerConnection.ontrack=null:this.context.peerConnection.onaddstream=null,this.context.peerConnection.onremovestream=null,this.context.peerConnection.onicecandidate=null,this.context.peerConnection.oniceconnectionstatechange=null,this.context.peerConnection.onsignalingstatechange=null,this.context.peerConnection.onicegatheringstatechange=null,this.context.peerConnection.onnegotiationneeded=null,"closed"!==this.context.peerConnection.signalingState&&this.context.peerConnection.close(),this.context.peerConnection=null,this.context.signalingConnection.close())}wait(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}}});
